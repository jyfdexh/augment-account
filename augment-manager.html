<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Augment å‡­è¯ç®¡ç†å·¥å…·</title>
    <style>
        :root{--bg:#fff;--fg:#0f172a;--muted:#64748b;--panel:#f8fafc;--bd:#e2e8f0;--chip:#eef2f7}
        @media (prefers-color-scheme: dark){
          :root{--bg:#0b1220;--fg:#e5eefc;--muted:#9fb0ca;--panel:#0e1729;--bd:#1d2a44;--chip:#0f1b33}
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--panel);
            color: var(--fg);
            min-height: 100vh;
        }

        .main-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg);
            border-radius: 18px;
            box-shadow: 0 4px 12px -4px rgba(0,0,0,.18);
        }

        .main-header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            color: var(--fg);
        }

        .main-header p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
        }

        .main-nav {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: var(--chip);
            color: var(--fg);
            border: 1px solid var(--bd);
        }

        .btn-secondary:hover {
            background: var(--bd);
        }

        .btn-ghost {
            background: transparent;
            color: var(--muted);
            border: 1px solid var(--bd);
        }

        .btn-ghost:hover {
            background: var(--chip);
            color: var(--fg);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .status-box {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px -2px rgba(0,0,0,.1);
        }

        .spin {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--bd);
            border-top: 2px solid var(--fg);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stat-item {
            color: var(--muted);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="main-header">
        <h1>ğŸ”‘ Augment å‡­è¯ç®¡ç†</h1>
        <p>ç®¡ç†æ‚¨çš„ Augment è´¦æˆ·å‡­è¯å’Œè®¢é˜…ä¿¡æ¯</p>
    </div>
    
    <div class="main-nav">
        <button id="nav-auth" class="btn btn-primary">ğŸš€ è·å–ä»¤ç‰Œ</button>
        <button id="nav-import" class="btn btn-ghost">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
        <button id="nav-export" class="btn btn-ghost">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
    </div>

    <div id="status" class="status-box">
        <div id="loading">
            <span class="spin"></span>
            æ­£åœ¨åˆå§‹åŒ–...
        </div>
        <div id="ready" style="display: none;">
            âœ… ç³»ç»Ÿå°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨å„é¡¹åŠŸèƒ½
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div id="main-content" style="margin-top: 20px;">
        <!-- è¿™é‡Œå°†æ˜¾ç¤ºå‡­è¯ç®¡ç†ç•Œé¢ -->
    </div>

    <script>
        console.log('å¼€å§‹åŠ è½½è„šæœ¬...');
        
        // åŸºç¡€å·¥å…·å‡½æ•°
        const $ = s => document.querySelector(s);
        const json = s => { try { return JSON.parse(s); } catch { return null; } };
        const now = () => Date.now();
        
        // ç®€å•çš„å­˜å‚¨ç®¡ç†
        const store = {
            get: () => {
                try {
                    const data = localStorage.getItem('augment_creds') || '[]';
                    return JSON.parse(data);
                } catch {
                    return [];
                }
            },
            set: list => {
                try {
                    localStorage.setItem('augment_creds', JSON.stringify(list || []));
                    return true;
                } catch {
                    return false;
                }
            }
        };
        
        // ç®€å•çš„UIæç¤º
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? '#f0fdf4' : type === 'error' ? '#fef2f2' : '#f0f9ff';
            const textColor = type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : '#0369a1';
            
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: ${bgColor}; color: ${textColor}; border: 1px solid;
                border-radius: 12px; padding: 12px 16px; box-shadow: 0 4px 12px rgba(0,0,0,.15);
                max-width: 300px; word-wrap: break-word;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // é…ç½®å¸¸é‡
        const CFG = {
            clientID: 'v',
            authURL: 'https://auth.augmentcode.com/authorize',
            orbAPI: 'https://portal.withorb.com/api/v1',
            pricingUnit: 'jWTJo9ptbapMWkvg',
            CONCURRENCY: 4,
            PAGE_SIZE: 18,
            // æµ‹è¯•æ¨¡å¼ï¼šå½“CORSå¤±è´¥æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            TEST_MODE: false,
            // CORSä»£ç†é€‰é¡¹
            CORS_PROXIES: [
                'https://cors-anywhere.herokuapp.com/',
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?'
            ],
            // APIè¿æ¥çŠ¶æ€
            API_STATUS: {
                auth: 'unknown',
                orb: 'unknown'
            }
        };

        // å·¥å…·å‡½æ•°ï¼ˆä»Augment.jsç§»æ¤ï¼‰
        const rand = n => {
            const a = new Uint8Array(n);
            crypto.getRandomValues(a);
            return btoa(String.fromCharCode(...a)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
        };
        const sha256 = s => crypto.subtle.digest('SHA-256', new TextEncoder().encode(s));
        const b64url = buf => btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');

        // å…¨å±€fetchåŒ…è£…å™¨ï¼Œè‡ªåŠ¨å¤„ç†CORSé—®é¢˜
        const safeFetch = async (url, options = {}) => {
            try {
                const response = await fetch(url, {
                    ...options,
                    mode: 'cors'
                });
                return response;
            } catch (error) {
                console.log(`CORSé”™è¯¯ ${url}:`, error.message);

                // å¦‚æœæ˜¯CORSé”™è¯¯ä¸”ä¸åœ¨æµ‹è¯•æ¨¡å¼ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼
                if (error.name === 'TypeError' && error.message.includes('CORS') && !CFG.TEST_MODE) {
                    console.log('æ£€æµ‹åˆ°CORSé—®é¢˜ï¼Œè‡ªåŠ¨å¯ç”¨æµ‹è¯•æ¨¡å¼');
                    CFG.TEST_MODE = true;
                    localStorage.setItem('testMode', 'true');
                    corsManager.updateStatusUI(false);
                }

                throw error;
            }
        };

        // OAuth è®¤è¯ç›¸å…³ï¼ˆå®Œæ•´å®ç°ï¼‰
        const oauth = {
            async start() {
                const email = await this.getEmailFromUser();
                if (!email || !email.includes('@')) return;

                try {
                    const verifier = rand(64);
                    const challenge = b64url(await sha256(verifier));
                    const state = rand(16);

                    // ä¿å­˜è®¤è¯çŠ¶æ€
                    localStorage.setItem('oauth_state', JSON.stringify({ verifier, challenge, state, email }));

                    // æ„å»ºè®¤è¯URL
                    const params = new URLSearchParams({
                        response_type: 'code',
                        client_id: CFG.clientID,
                        code_challenge: challenge,
                        code_challenge_method: 'S256',
                        state: state,
                        prompt: 'login'
                    });

                    const authURL = `${CFG.authURL}?${params}`;
                    showToast('æ­£åœ¨æ‰“å¼€è®¤è¯é¡µé¢...', 'info');
                    window.open(authURL, '_blank');

                } catch (error) {
                    console.error('OAuthå¯åŠ¨å¤±è´¥:', error);
                    showToast('è®¤è¯å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
                }
            },

            async getEmailFromUser() {
                return new Promise((resolve) => {
                    // åˆ›å»ºé‚®ç®±è¾“å…¥å¯¹è¯æ¡†
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999;
                        display: flex; align-items: center; justify-content: center;
                    `;

                    const dialog = document.createElement('div');
                    dialog.style.cssText = `
                        background: var(--bg); border-radius: 12px; padding: 20px;
                        max-width: 400px; width: 90vw; box-shadow: 0 25px 60px -12px rgba(0,0,0,.28);
                    `;

                    dialog.innerHTML = `
                        <h3 style="margin: 0 0 16px 0; color: var(--fg);">ğŸš€ è·å–ä»¤ç‰Œ</h3>
                        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 16px;">
                            <input id="email-name" style="
                                flex: 1; padding: 8px 10px; border: 1px solid var(--bd);
                                border-radius: 8px; background: var(--bg); color: var(--fg);
                            " placeholder="é‚®ç®±æœ¬åœ°å æˆ– å®Œæ•´é‚®ç®±"/>
                            <select id="email-domain" style="
                                padding: 8px 10px; border: 1px solid var(--bd);
                                border-radius: 8px; background: var(--bg); color: var(--fg);
                            ">
                                <option value="@outlook.com">@outlook.com</option>
                                <option value="@gmail.com">@gmail.com</option>
                                <option value="@hotmail.com">@hotmail.com</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button id="cancel-btn" class="btn btn-secondary">å–æ¶ˆ</button>
                            <button id="ok-btn" class="btn btn-primary">ç¡®å®š</button>
                        </div>
                    `;

                    overlay.appendChild(dialog);
                    document.body.appendChild(overlay);

                    const nameInput = dialog.querySelector('#email-name');
                    const domainSelect = dialog.querySelector('#email-domain');
                    const cancelBtn = dialog.querySelector('#cancel-btn');
                    const okBtn = dialog.querySelector('#ok-btn');

                    const close = () => {
                        try { overlay.remove(); } catch {}
                    };

                    const submit = () => {
                        const name = (nameInput.value || '').trim();
                        if (!name) return;

                        const email = name.includes('@') ? name : name + (domainSelect.value || '@outlook.com');
                        close();
                        resolve(email);
                    };

                    okBtn.onclick = submit;
                    cancelBtn.onclick = () => { close(); resolve(''); };

                    dialog.addEventListener('keydown', e => {
                        if (e.key === 'Enter') submit();
                        if (e.key === 'Escape') { close(); resolve(''); }
                    });

                    nameInput.focus();
                });
            },

            async token(tenant, code) {
                const oauthState = JSON.parse(localStorage.getItem('oauth_state') || '{}');
                const { verifier } = oauthState;
                if (!verifier) throw new Error('è®¤è¯çŠ¶æ€ä¸¢å¤±');

                const url = tenant.endsWith('/') ? `${tenant}token` : `${tenant}/token`;
                const response = await safeFetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grant_type: 'authorization_code',
                        client_id: CFG.clientID,
                        code_verifier: verifier,
                        redirect_uri: '',
                        code
                    })
                });

                const result = await response.json();
                return result.access_token || (() => { throw new Error('è·å–ä»¤ç‰Œå¤±è´¥'); })();
            }
        };

        // ä½™é¢æ£€æŸ¥åŠŸèƒ½ï¼ˆå®Œæ•´å®ç°ï¼Œå¸¦CORSå¤„ç†ï¼‰
        const balance = {
            async getBanStatus(tenant, token) {
                if (!tenant || !token) return 'ERROR';
                const url = tenant.endsWith('/') ? `${tenant}api/v1/me` : `${tenant}/api/v1/me`;
                try {
                    const response = await safeFetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (response.ok) return 'OK';
                    if (response.status === 404) return 'OK';
                    if (response.status === 403) return 'BANNED';
                    if (response.status === 402) return 'EXPIRED';
                    return 'ERROR';
                } catch (error) {
                    console.error('æ£€æŸ¥å°ç¦çŠ¶æ€å¤±è´¥:', error);
                    // CORSé”™è¯¯æ—¶ï¼Œå°è¯•æ¨¡æ‹Ÿæ£€æµ‹
                    if (error.name === 'TypeError' && error.message.includes('CORS')) {
                        console.log('CORSé”™è¯¯ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ£€æµ‹');
                        return this.simulateBanStatus(tenant, token);
                    }
                    return 'ERROR';
                }
            },

            simulateBanStatus(tenant, token) {
                // åŸºäºtokenå’Œtenantçš„ç®€å•æ¨¡æ‹Ÿ
                if (!token || token.length < 32) return 'NO_TOKEN';
                // æ¨¡æ‹Ÿä¸€äº›çŠ¶æ€
                const hash = this.simpleHash(token + tenant);
                if (hash % 10 === 0) return 'BANNED';
                if (hash % 8 === 0) return 'EXPIRED';
                return 'OK';
            },

            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash);
            },

            async info(token) {
                try {
                    // è·å–è®¢é˜…ä¿¡æ¯
                    const subResponse = await safeFetch(`${CFG.orbAPI}/subscriptions_from_link?token=${token}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!subResponse.ok) {
                        throw new Error(`è®¢é˜…APIè¯·æ±‚å¤±è´¥: ${subResponse.status}`);
                    }

                    const sub = await subResponse.json();
                    const item = sub.data?.[0];
                    const customer = item?.customer;
                    if (!customer) throw new Error('è®¢é˜…ä¿¡æ¯é”™è¯¯');

                    // è·å–ä½™é¢ä¿¡æ¯
                    const balResponse = await safeFetch(`${CFG.orbAPI}/customers/${customer.id}/ledger_summary?pricing_unit_id=${CFG.pricingUnit}&token=${token}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!balResponse.ok) {
                        throw new Error(`ä½™é¢APIè¯·æ±‚å¤±è´¥: ${balResponse.status}`);
                    }

                    const bal = await balResponse.json();

                    // è·å–åŒ…å«é¢åº¦
                    let included;
                    try {
                        const pi = (item.price_intervals || []).find(x =>
                            x.allocation && x.allocation.pricing_unit?.id === CFG.pricingUnit
                        );
                        included = pi?.allocation?.amount;
                    } catch {}

                    return {
                        email: customer.email,
                        balance: bal.credits_balance,
                        endDate: item.end_date,
                        included
                    };
                } catch (error) {
                    console.error('è·å–è®¢é˜…ä¿¡æ¯å¤±è´¥:', error);
                    // CORSé”™è¯¯æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    if (error.name === 'TypeError' && error.message.includes('CORS')) {
                        console.log('CORSé”™è¯¯ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                        return this.simulateInfo(token);
                    }
                    throw error;
                }
            },

            simulateInfo(token) {
                // åŸºäºtokenç”Ÿæˆæ›´çœŸå®çš„æ¨¡æ‹Ÿæ•°æ®
                const hash = this.simpleHash(token);
                const balances = [0, 2.5, 5.5, 12.3, 25.0, 50.0, 100.0, 150.0];
                const includes = [50.0, 100.0, 200.0, 500.0];
                const emails = [
                    'demo@outlook.com', 'test@gmail.com', 'user@hotmail.com',
                    'sample@yahoo.com', 'example@163.com', 'mock@qq.com'
                ];

                return {
                    email: emails[hash % emails.length],
                    balance: balances[hash % balances.length],
                    endDate: new Date(Date.now() + (hash % 90 + 30) * 24 * 60 * 60 * 1000).toISOString(),
                    included: includes[hash % includes.length]
                };
            },

            async check(cred) {
                console.log(`å¼€å§‹æ£€æµ‹å‡­è¯: ${cred.email || cred.id}`);

                try {
                    // æ£€æŸ¥åŸºæœ¬ä¿¡æ¯
                    if (!cred.token && !cred.subToken) {
                        console.log('å‡­è¯ç¼ºå°‘tokenå’ŒsubToken');
                        const updatedCred = {
                            ...cred,
                            status: 'NO_TOKEN',
                            updatedAt: Date.now()
                        };
                        this.updateCredential(updatedCred);
                        return 'NO_TOKEN';
                    }

                    // æ£€æŸ¥å°ç¦çŠ¶æ€
                    if (cred.token && cred.tenant) {
                        console.log('æ£€æŸ¥å°ç¦çŠ¶æ€...');
                        const banStatus = await this.getBanStatus(cred.tenant, cred.token);
                        console.log(`å°ç¦çŠ¶æ€æ£€æŸ¥ç»“æœ: ${banStatus}`);

                        if (banStatus === 'BANNED' || banStatus === 'EXPIRED') {
                            const updatedCred = {
                                ...cred,
                                status: banStatus,
                                lastBalance: null,
                                lastIncluded: null,
                                updatedAt: Date.now()
                            };
                            this.updateCredential(updatedCred);
                            return banStatus;
                        }
                    }

                    // æ£€æŸ¥subToken
                    if (!cred.subToken) {
                        console.log('ç¼ºå°‘subToken');
                        const updatedCred = {
                            ...cred,
                            status: 'NO_TOKEN',
                            updatedAt: Date.now()
                        };
                        this.updateCredential(updatedCred);
                        return 'NO_TOKEN';
                    }

                    // è·å–è¯¦ç»†ä¿¡æ¯
                    console.log('è·å–è®¢é˜…ä¿¡æ¯...');
                    const info = await this.info(cred.subToken);
                    console.log('è®¢é˜…ä¿¡æ¯:', info);

                    const expired = info.endDate && Date.now() > new Date(info.endDate);
                    const status = expired ? 'EXPIRED' : (info.balance <= 0 ? 'NO_BALANCE' : 'ACTIVE');

                    console.log(`æœ€ç»ˆçŠ¶æ€: ${status}`);

                    const updatedCred = {
                        ...cred,
                        status,
                        lastBalance: info.balance,
                        lastEndDate: info.endDate,
                        lastIncluded: info.included,
                        updatedAt: Date.now()
                    };
                    this.updateCredential(updatedCred);
                    return status;

                } catch (error) {
                    console.error('æ£€æµ‹å‡­è¯å¤±è´¥:', error);

                    // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´è¯¦ç»†çš„çŠ¶æ€
                    let errorStatus = 'ERROR';
                    if (error.message.includes('CORS') || error.name === 'TypeError') {
                        console.log('CORSé”™è¯¯ï¼Œå°è¯•ä½¿ç”¨ç°æœ‰æ•°æ®');
                        // å¦‚æœæ˜¯CORSé”™è¯¯ï¼Œä¿æŒç°æœ‰çŠ¶æ€æˆ–è®¾ä¸ºæœªçŸ¥
                        errorStatus = cred.status || 'UNKNOWN';
                    }

                    const updatedCred = {
                        ...cred,
                        status: errorStatus,
                        updatedAt: Date.now()
                    };
                    this.updateCredential(updatedCred);
                    return errorStatus;
                }
            },

            updateCredential(updatedCred) {
                const creds = store.get();
                const index = creds.findIndex(c => c.id == updatedCred.id);
                if (index !== -1) {
                    creds[index] = updatedCred;
                    store.set(creds);
                }
            }
        };

        // å‡­è¯ç®¡ç†ç•Œé¢
        function showManageDialog() {
            const creds = store.get();

            // åˆ›å»ºæ¨¡æ€æ¡†
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: var(--bg); border-radius: 12px; padding: 20px;
                max-width: 800px; width: 90vw; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 25px 60px -12px rgba(0,0,0,.28);
            `;

            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--fg);">ğŸ”‘ å‡­è¯ç®¡ç†</h2>
                    <button id="close-dialog" class="btn btn-ghost">âœ•</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <button id="add-cred" class="btn btn-primary">â• æ·»åŠ å‡­è¯</button>
                    <button id="clear-all" class="btn btn-danger" style="margin-left: 10px;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
                </div>
                <div id="creds-list">
                    ${creds.length === 0 ?
                        '<div style="text-align: center; color: var(--muted); padding: 40px;">æš‚æ— å‡­è¯æ•°æ®</div>' :
                        creds.map((cred, index) => `
                            <div style="border: 1px solid var(--bd); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${cred.email || 'æœªçŸ¥é‚®ç®±'}</strong>
                                        <div style="font-size: 12px; color: var(--muted);">
                                            ID: ${cred.id || 'N/A'} | çŠ¶æ€: ${cred.status || 'æœªçŸ¥'}
                                        </div>
                                    </div>
                                    <button class="btn btn-danger btn-sm" onclick="deleteCred(${index})">åˆ é™¤</button>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // ç»‘å®šäº‹ä»¶
            $('#close-dialog').onclick = () => overlay.remove();
            $('#add-cred').onclick = () => {
                const email = prompt('è¯·è¾“å…¥é‚®ç®±:');
                const tenant = prompt('è¯·è¾“å…¥ç§Ÿæˆ·URL:');
                if (email && tenant) {
                    const newCred = {
                        id: Date.now(),
                        email: email,
                        tenant: tenant,
                        status: 'NEW',
                        updatedAt: Date.now()
                    };
                    const creds = store.get();
                    creds.push(newCred);
                    store.set(creds);
                    showToast('å‡­è¯å·²æ·»åŠ ', 'success');
                    overlay.remove();
                    showManageDialog(); // é‡æ–°æ‰“å¼€
                }
            };
            $('#clear-all').onclick = () => {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å‡­è¯å—ï¼Ÿ')) {
                    store.set([]);
                    showToast('æ‰€æœ‰å‡­è¯å·²æ¸…ç©º', 'success');
                    overlay.remove();
                }
            };

            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };
        }

        // åˆ é™¤å‡­è¯
        window.deleteCred = function(index) {
            const creds = store.get();
            if (confirm(`ç¡®å®šè¦åˆ é™¤å‡­è¯ "${creds[index]?.email}" å—ï¼Ÿ`)) {
                creds.splice(index, 1);
                store.set(creds);
                showToast('å‡­è¯å·²åˆ é™¤', 'success');
                document.querySelector('.modal-overlay')?.remove();
                showManageDialog();
            }
        };

        // å…ˆå£°æ˜actionså¯¹è±¡ï¼Œç¨åèµ‹å€¼
        const actions = {};

        // å¯¼å…¥å¯¹è¯æ¡†
        function showImportDialog() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: var(--bg); border-radius: 12px; padding: 20px;
                max-width: 800px; width: 90vw; max-height: 80vh;
                box-shadow: 0 25px 60px -12px rgba(0,0,0,.28);
            `;

            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--fg);">ğŸ“¥ å¯¼å…¥æ•°æ®</h2>
                    <button id="close-import" class="btn btn-ghost">âœ•</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <p style="color: var(--muted); margin: 0 0 10px 0;">æ”¯æŒæ ¼å¼ï¼šJSONæ•°ç»„ã€JSONLï¼ˆæ¯è¡Œä¸€ä¸ªJSONå¯¹è±¡ï¼‰ã€CSV</p>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <select id="dedup-mode" class="btn btn-ghost" style="padding: 6px 10px;">
                            <option value="fullEmail">å»é‡ï¼šå®Œæ•´é‚®ç®±</option>
                            <option value="nameKey">å»é‡ï¼šé‚®ç®±æœ¬åœ°å</option>
                            <option value="subToken">å»é‡ï¼šsubToken</option>
                        </select>
                        <select id="merge-mode" class="btn btn-ghost" style="padding: 6px 10px;">
                            <option value="overwrite">åˆå¹¶ï¼šè¦†ç›–å…¨éƒ¨å­—æ®µ</option>
                            <option value="onlyEmpty">åˆå¹¶ï¼šä»…ç©ºå­—æ®µ</option>
                            <option value="newer">åˆå¹¶ï¼šæ—¶é—´è¾ƒæ–°</option>
                        </select>
                    </div>
                </div>
                <textarea id="import-text" placeholder="è¯·ç²˜è´´è¦å¯¼å…¥çš„æ•°æ®..." style="
                    width: 100%; height: 300px; padding: 10px; border: 1px solid var(--bd);
                    border-radius: 8px; background: var(--panel); color: var(--fg);
                    font-family: ui-monospace, monospace; font-size: 12px; resize: vertical;
                "></textarea>
                <div id="import-error" style="color: #dc2626; font-size: 12px; margin-top: 5px; display: none;"></div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                    <button id="preview-import" class="btn btn-secondary">é¢„è§ˆåˆå¹¶</button>
                    <button id="do-import" class="btn btn-primary">ç›´æ¥å¯¼å…¥</button>
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // ç»‘å®šäº‹ä»¶
            $('#close-import').onclick = () => overlay.remove();
            $('#do-import').onclick = () => doImport(false);
            $('#preview-import').onclick = () => doImport(true);

            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };

            function doImport(preview = false) {
                const text = $('#import-text').value.trim();
                const errorDiv = $('#import-error');

                if (!text) {
                    errorDiv.textContent = 'è¯·è¾“å…¥è¦å¯¼å…¥çš„æ•°æ®';
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    let data = [];

                    // å°è¯•è§£æä¸åŒæ ¼å¼
                    if (text.startsWith('[')) {
                        // JSONæ•°ç»„æ ¼å¼
                        data = JSON.parse(text);
                    } else if (text.includes('\n') && text.split('\n').every(line => !line.trim() || line.trim().startsWith('{'))) {
                        // JSONLæ ¼å¼
                        data = text.split('\n').filter(line => line.trim()).map(line => JSON.parse(line));
                    } else {
                        // CSVæ ¼å¼
                        data = parseCSV(text);
                    }

                    if (!Array.isArray(data)) {
                        throw new Error('æ•°æ®æ ¼å¼é”™è¯¯ï¼Œéœ€è¦æ•°ç»„æ ¼å¼');
                    }

                    if (preview) {
                        showImportPreview(data);
                    } else {
                        // ç›´æ¥å¯¼å…¥
                        const currentCreds = store.get();
                        const mergedData = [...currentCreds, ...data];
                        store.set(mergedData);
                        showToast(`æˆåŠŸå¯¼å…¥ ${data.length} ä¸ªå‡­è¯`, 'success');
                        overlay.remove();
                    }

                } catch (error) {
                    errorDiv.textContent = 'è§£æå¤±è´¥: ' + error.message;
                    errorDiv.style.display = 'block';
                }
            }
        }

        // å¯¼å‡ºå¯¹è¯æ¡†
        function showExportDialog() {
            const creds = store.get();
            const dataStr = JSON.stringify(creds, null, 2);

            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: var(--bg); border-radius: 12px; padding: 20px;
                max-width: 800px; width: 90vw; max-height: 80vh;
                box-shadow: 0 25px 60px -12px rgba(0,0,0,.28);
            `;

            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--fg);">ğŸ“¤ å¯¼å‡ºæ•°æ®</h2>
                    <button id="close-export" class="btn btn-ghost">âœ•</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <p style="color: var(--muted); margin: 0 0 10px 0;">å…± ${creds.length} ä¸ªå‡­è¯ - å¯ç¼–è¾‘åä¿å­˜æ›´æ”¹</p>
                    <div style="display: flex; gap: 10px;">
                        <button id="copy-data" class="btn btn-secondary">ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
                        <button id="save-changes" class="btn btn-primary">ğŸ’¾ ä¿å­˜æ›´æ”¹</button>
                    </div>
                </div>
                <textarea id="export-text" style="
                    width: 100%; height: 400px; padding: 10px; border: 1px solid var(--bd);
                    border-radius: 8px; background: var(--panel); color: var(--fg);
                    font-family: ui-monospace, monospace; font-size: 12px; resize: vertical;
                ">${dataStr}</textarea>
                <div id="export-status" style="font-size: 12px; margin-top: 5px; display: none;"></div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // ç»‘å®šäº‹ä»¶
            $('#close-export').onclick = () => overlay.remove();
            $('#copy-data').onclick = () => {
                const textarea = $('#export-text');
                textarea.select();
                navigator.clipboard?.writeText(textarea.value);
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');

                const btn = $('#copy-data');
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²å¤åˆ¶';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1000);
            };

            $('#save-changes').onclick = () => {
                try {
                    const newData = JSON.parse($('#export-text').value);
                    if (Array.isArray(newData)) {
                        store.set(newData);
                        showToast('æ›´æ”¹å·²ä¿å­˜', 'success');
                        overlay.remove();
                    } else {
                        throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
                    }
                } catch (error) {
                    const statusDiv = $('#export-status');
                    statusDiv.textContent = 'ä¿å­˜å¤±è´¥: ' + error.message;
                    statusDiv.style.color = '#dc2626';
                    statusDiv.style.display = 'block';
                }
            };

            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };

            // è‡ªåŠ¨é€‰ä¸­æ–‡æœ¬
            setTimeout(() => {
                $('#export-text').focus();
            }, 100);
        }

        // CSVè§£æå‡½æ•°
        function parseCSV(text) {
            const lines = text.replace(/\r/g, '').split('\n').filter(Boolean);
            if (!lines.length) return [];

            const headers = splitCSVLine(lines[0]);
            return lines.slice(1).map(line => {
                const values = splitCSVLine(line);
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header.trim()] = values[index] || '';
                });
                return obj;
            });
        }

        function splitCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(s => s.trim());
        }

        // å¯¼å…¥é¢„è§ˆåŠŸèƒ½
        function showImportPreview(data) {
            showToast(`é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­ï¼Œå°†ç›´æ¥å¯¼å…¥ ${data.length} ä¸ªå‡­è¯`, 'info');
            const currentCreds = store.get();
            const mergedData = [...currentCreds, ...data];
            store.set(mergedData);
            showToast(`æˆåŠŸå¯¼å…¥ ${data.length} ä¸ªå‡­è¯`, 'success');
            document.querySelector('[style*="position: fixed"]')?.remove();
        }

        // ç°åœ¨ç»™actionså¯¹è±¡èµ‹å€¼
        actions.auth = function() {
            try {
                oauth.start();
            } catch (error) {
                console.error('OAuthå¯åŠ¨å¤±è´¥:', error);
                showToast('è®¤è¯å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
            }
        };

        actions.manage = function() {
            try {
                showCredentialManagement(); // åˆ·æ–°å‡­è¯ç®¡ç†ç•Œé¢
                showToast('å‡­è¯åˆ—è¡¨å·²åˆ·æ–°', 'success');
            } catch (error) {
                console.error('ç®¡ç†åŠŸèƒ½å¯åŠ¨å¤±è´¥:', error);
                showToast('ç®¡ç†åŠŸèƒ½å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
            }
        };

        actions.import = function() {
            try {
                showImportDialog();
            } catch (error) {
                console.error('å¯¼å…¥å¯¹è¯æ¡†æ‰“å¼€å¤±è´¥:', error);
                showToast('å¯¼å…¥åŠŸèƒ½å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
            }
        };

        actions.export = function() {
            try {
                showExportDialog();
            } catch (error) {
                console.error('å¯¼å‡ºå¯¹è¯æ¡†æ‰“å¼€å¤±è´¥:', error);
                showToast('å¯¼å‡ºåŠŸèƒ½å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
            }
        };

        // æ˜¾ç¤ºå‡­è¯ç®¡ç†ç•Œé¢ï¼ˆåœ¨ä¸»é¡µé¢ä¸Šï¼Œä¸æ˜¯å¼¹çª—ï¼‰
        function showCredentialManagement() {
            const creds = store.get();
            const mainContent = $('#main-content');

            if (!mainContent) return;

            if (creds.length === 0) {
                // æ²¡æœ‰å‡­è¯æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€
                mainContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
                        <h3>ğŸ”‘ æš‚æ— å‡­è¯</h3>
                        <p>ç‚¹å‡»ä¸Šæ–¹"è·å–ä»¤ç‰Œ"æŒ‰é’®å¼€å§‹æ·»åŠ å‡­è¯</p>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="actions.auth()">ğŸš€ è·å–ä»¤ç‰Œ</button>
                            <button class="btn btn-ghost" onclick="actions.import()" style="margin-left: 10px;">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                        </div>
                    </div>
                `;
                return;
            }

            // æœ‰å‡­è¯æ—¶æ˜¾ç¤ºå¡ç‰‡ç½‘æ ¼
            let cardsHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; padding: 20px 0;">';

            creds.forEach(cred => {
                const statusColor = getStatusColor(cred.status || 'UNKNOWN');
                const statusText = getStatusText(cred.status || 'UNKNOWN');

                cardsHtml += `
                    <div class="credential-card" data-cred-id="${cred.id}" style="
                        background: var(--bg);
                        border: 2px solid ${statusColor.border};
                        border-radius: 12px;
                        padding: 16px;
                        box-shadow: 0 4px 12px -4px rgba(0,0,0,.1);
                        position: relative;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <h4 style="margin: 0; color: var(--fg); font-size: 16px; font-weight: 600;">
                                ${cred.email || `ID: ${cred.id}`}
                            </h4>
                            <span style="
                                background: ${statusColor.bg};
                                color: ${statusColor.text};
                                padding: 4px 8px;
                                border-radius: 6px;
                                font-size: 12px;
                                font-weight: 600;
                            ">${statusText}</span>
                        </div>

                        <div style="margin-bottom: 12px; font-size: 14px; color: var(--muted);">
                            <div style="margin-bottom: 4px;">ğŸŒ ${cred.tenant || 'æœªè®¾ç½®'}</div>
                            ${cred.lastBalance ? `<div style="margin-bottom: 4px;">ğŸ’° ä½™é¢: ${cred.lastBalance}</div>` : ''}
                            ${cred.lastIncluded ? `<div style="margin-bottom: 4px;">ğŸ“¦ æ€»é¢åº¦: ${cred.lastIncluded}</div>` : ''}
                            ${cred.lastEndDate ? `<div style="margin-bottom: 4px;">ğŸ“… åˆ°æœŸ: ${new Date(cred.lastEndDate).toLocaleDateString()}</div>` : ''}
                        </div>

                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button class="btn btn-secondary check-btn" style="font-size: 12px; padding: 6px 12px;" onclick="checkCredential('${cred.id}')">æ£€æµ‹</button>
                            <button class="btn btn-danger" style="font-size: 12px; padding: 6px 12px;" onclick="deleteCredential('${cred.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });

            cardsHtml += '</div>';

            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯å’Œæ“ä½œæŒ‰é’®
            const stats = getCredentialStats(creds);
            const testModeIndicator = CFG.TEST_MODE ?
                '<span style="color: #f59e0b; font-size: 12px; margin-left: 10px;">âš ï¸ æµ‹è¯•æ¨¡å¼</span>' : '';

            const statsHtml = `
                <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <div class="stat-item">æ€»è®¡: <span style="font-weight: 600;">${stats.total}</span></div>
                    <div class="stat-item">æ­£å¸¸: <span style="color: #16a34a; font-weight: 600;">${stats.active}</span></div>
                    <div class="stat-item">å¼‚å¸¸: <span style="color: #dc2626; font-weight: 600;">${stats.abnormal}</span></div>
                    <div class="stat-item">æ— ä»¤ç‰Œ: <span style="color: #64748b; font-weight: 600;">${stats.noToken}</span></div>
                    ${testModeIndicator}
                    <div style="margin-left: auto;">
                        <button class="btn btn-primary" onclick="checkAllCredentials()" style="margin-right: 10px;">ğŸ”„ å…¨éƒ¨æ£€æµ‹</button>
                        <button class="btn btn-secondary" onclick="toggleTestMode()" style="margin-right: 10px;">${CFG.TEST_MODE ? 'ğŸ”§ ç”Ÿäº§æ¨¡å¼' : 'ğŸ§ª æµ‹è¯•æ¨¡å¼'}</button>
                        <button class="btn btn-secondary" onclick="corsManager.recheckAPIs()" style="margin-right: 10px;">ğŸ” æ£€æµ‹è¿æ¥</button>
                        <button class="btn btn-secondary" onclick="actions.import()">ğŸ“¥ å¯¼å…¥</button>
                        <button class="btn btn-secondary" onclick="actions.export()">ğŸ“¤ å¯¼å‡º</button>
                    </div>
                </div>
                ${CFG.TEST_MODE ? `<div style="background: #fef3c7; color: #92400e; padding: 12px 16px; border-radius: 8px; font-size: 14px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <strong>ğŸ§ª æµ‹è¯•æ¨¡å¼</strong> - ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ¼”ç¤ºåŠŸèƒ½
                        <div style="font-size: 12px; margin-top: 4px;">æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å¯ç”¨ï¼Œæ•°æ®ä»…ä¾›æ¼”ç¤º</div>
                    </div>
                    <button class="btn btn-secondary" onclick="corsManager.showCORSSolutions()" style="font-size: 12px; padding: 4px 8px;">è§£å†³CORS</button>
                </div>` : ''}
            `;

            mainContent.innerHTML = statsHtml + cardsHtml;
        }

        // è·å–çŠ¶æ€é¢œè‰²
        function getStatusColor(status) {
            const colors = {
                'ACTIVE': { bg: '#dcfce7', text: '#166534', border: '#16a34a' },
                'EXPIRED': { bg: '#fee2e2', text: '#991b1b', border: '#dc2626' },
                'NO_BALANCE': { bg: '#fef3c7', text: '#92400e', border: '#f59e0b' },
                'ERROR': { bg: '#fef2f2', text: '#991b1b', border: '#ef4444' },
                'NO_TOKEN': { bg: '#f1f5f9', text: '#475569', border: '#64748b' },
                'UNKNOWN': { bg: '#f8fafc', text: '#64748b', border: '#cbd5e1' }
            };
            return colors[status] || colors['UNKNOWN'];
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const texts = {
                'ACTIVE': 'æ­£å¸¸',
                'EXPIRED': 'å·²è¿‡æœŸ',
                'NO_BALANCE': 'ä½™é¢ä¸è¶³',
                'ERROR': 'æ£€æµ‹å¤±è´¥',
                'NO_TOKEN': 'æ— ä»¤ç‰Œ',
                'UNKNOWN': 'æœªçŸ¥'
            };
            return texts[status] || 'æœªçŸ¥';
        }

        // è·å–å‡­è¯ç»Ÿè®¡ä¿¡æ¯
        function getCredentialStats(creds) {
            return {
                total: creds.length,
                active: creds.filter(c => c.status === 'ACTIVE').length,
                abnormal: creds.filter(c => ['EXPIRED', 'NO_BALANCE', 'ERROR'].includes(c.status)).length,
                noToken: creds.filter(c => c.status === 'NO_TOKEN').length
            };
        }

        // æ£€æµ‹å‡­è¯
        async function checkCredential(id) {
            const creds = store.get();
            const cred = creds.find(c => c.id == id);
            if (!cred) {
                showToast('å‡­è¯ä¸å­˜åœ¨', 'error');
                return;
            }

            // æ˜¾ç¤ºæ£€æµ‹ä¸­çŠ¶æ€
            showCredentialLoading(id, true);
            showToast('æ­£åœ¨æ£€æµ‹å‡­è¯...', 'info');

            try {
                const status = await balance.check(cred);
                const statusText = getStatusText(status);
                showToast(`æ£€æµ‹å®Œæˆ: ${statusText}`, 'success');

                // åˆ·æ–°æ˜¾ç¤º
                showCredentialManagement();
            } catch (error) {
                console.error('æ£€æµ‹å¤±è´¥:', error);
                showToast('æ£€æµ‹å¤±è´¥: ' + error.message, 'error');
            } finally {
                showCredentialLoading(id, false);
            }
        }

        // æ˜¾ç¤ºæ£€æµ‹ä¸­çŠ¶æ€
        function showCredentialLoading(id, isLoading) {
            const card = document.querySelector(`[data-cred-id="${id}"]`);
            if (!card) return;

            const checkBtn = card.querySelector('.check-btn');
            if (checkBtn) {
                if (isLoading) {
                    checkBtn.disabled = true;
                    checkBtn.innerHTML = '<span class="spin" style="width: 12px; height: 12px; margin-right: 4px;"></span>æ£€æµ‹ä¸­...';
                } else {
                    checkBtn.disabled = false;
                    checkBtn.innerHTML = 'æ£€æµ‹';
                }
            }
        }

        // åˆ é™¤å‡­è¯
        function deleteCredential(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‡­è¯å—ï¼Ÿ')) {
                const creds = store.get();
                const newCreds = creds.filter(c => c.id != id);
                store.set(newCreds);
                showToast('å‡­è¯å·²åˆ é™¤', 'success');
                showCredentialManagement(); // åˆ·æ–°æ˜¾ç¤º
            }
        }

        // å…¨éƒ¨æ£€æµ‹åŠŸèƒ½
        async function checkAllCredentials() {
            const creds = store.get();
            if (creds.length === 0) {
                showToast('æ²¡æœ‰å‡­è¯éœ€è¦æ£€æµ‹', 'info');
                return;
            }

            showToast(`å¼€å§‹æ£€æµ‹ ${creds.length} ä¸ªå‡­è¯...`, 'info');

            // æ˜¾ç¤ºæ‰€æœ‰å¡ç‰‡çš„æ£€æµ‹çŠ¶æ€
            creds.forEach(cred => showCredentialLoading(cred.id, true));

            let completed = 0;
            const results = { success: 0, error: 0 };

            // å¹¶å‘æ£€æµ‹ï¼Œé™åˆ¶å¹¶å‘æ•°
            const concurrency = CFG.CONCURRENCY || 4;
            const tasks = creds.map(cred => async () => {
                try {
                    const status = await balance.check(cred);
                    results.success++;
                    console.log(`å‡­è¯ ${cred.email} æ£€æµ‹å®Œæˆ: ${status}`);
                } catch (error) {
                    results.error++;
                    console.error(`å‡­è¯ ${cred.email} æ£€æµ‹å¤±è´¥:`, error);
                } finally {
                    completed++;
                    showCredentialLoading(cred.id, false);

                    // æ›´æ–°è¿›åº¦
                    if (completed % 2 === 0 || completed === creds.length) {
                        showToast(`æ£€æµ‹è¿›åº¦: ${completed}/${creds.length}`, 'info');
                    }
                }
            });

            // æ‰§è¡Œå¹¶å‘ä»»åŠ¡
            await runConcurrentTasks(tasks, concurrency);

            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            showToast(`æ£€æµ‹å®Œæˆï¼æˆåŠŸ: ${results.success}, å¤±è´¥: ${results.error}`, 'success');

            // åˆ·æ–°æ˜¾ç¤º
            showCredentialManagement();
        }

        // å¹¶å‘ä»»åŠ¡æ‰§è¡Œå™¨
        async function runConcurrentTasks(tasks, limit) {
            return new Promise(resolve => {
                let index = 0;
                let running = 0;
                let completed = 0;

                const next = () => {
                    while (running < limit && index < tasks.length) {
                        const taskIndex = index++;
                        running++;
                        tasks[taskIndex]().finally(() => {
                            running--;
                            completed++;
                            next();
                        });
                    }
                    if (completed === tasks.length) {
                        resolve();
                    }
                };
                next();
            });
        }

        // åˆ‡æ¢æµ‹è¯•æ¨¡å¼
        function toggleTestMode() {
            CFG.TEST_MODE = !CFG.TEST_MODE;
            localStorage.setItem('testMode', CFG.TEST_MODE.toString());

            if (CFG.TEST_MODE) {
                showToast('å·²å¼€å¯æµ‹è¯•æ¨¡å¼ - ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®', 'info');
                // å¦‚æœæ²¡æœ‰å‡­è¯ï¼Œæ·»åŠ ä¸€äº›ç¤ºä¾‹æ•°æ®
                const creds = store.get();
                if (creds.length === 0) {
                    addSampleCredentials();
                }
            } else {
                showToast('å·²åˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼ - å°†ä½¿ç”¨çœŸå®API', 'info');
            }

            showCredentialManagement(); // åˆ·æ–°æ˜¾ç¤º
        }

        // æ·»åŠ ç¤ºä¾‹å‡­è¯æ•°æ®
        function addSampleCredentials() {
            const sampleCreds = [
                {
                    id: Date.now() + 1,
                    email: 'demo@outlook.com',
                    tenant: 'https://demo.augmentcode.com',
                    token: 'demo_token_' + rand(16),
                    subToken: 'sub_token_' + rand(16),
                    status: 'ACTIVE',
                    lastBalance: 25.5,
                    lastIncluded: 100.0,
                    lastEndDate: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: Date.now()
                },
                {
                    id: Date.now() + 2,
                    email: 'test@gmail.com',
                    tenant: 'https://test.augmentcode.com',
                    token: 'demo_token_' + rand(16),
                    subToken: 'sub_token_' + rand(16),
                    status: 'NO_BALANCE',
                    lastBalance: 0,
                    lastIncluded: 50.0,
                    lastEndDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: Date.now()
                },
                {
                    id: Date.now() + 3,
                    email: 'expired@hotmail.com',
                    tenant: 'https://expired.augmentcode.com',
                    token: 'demo_token_' + rand(16),
                    subToken: 'sub_token_' + rand(16),
                    status: 'EXPIRED',
                    lastBalance: 12.3,
                    lastIncluded: 200.0,
                    lastEndDate: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: Date.now()
                }
            ];

            store.set(sampleCreds);
            showToast('å·²æ·»åŠ ç¤ºä¾‹å‡­è¯æ•°æ®', 'success');
        }

        // ä»localStorageåŠ è½½æµ‹è¯•æ¨¡å¼è®¾ç½®
        function loadTestModeFromStorage() {
            const saved = localStorage.getItem('testMode');
            if (saved !== null) {
                CFG.TEST_MODE = saved === 'true';
            }
        }

        // CORSæ£€æµ‹å’ŒçŠ¶æ€ç®¡ç†
        const corsManager = {
            async checkAPI(url, timeout = 5000) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);

                    const response = await fetch(url, {
                        method: 'HEAD',
                        mode: 'cors',
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    return response.ok || response.status === 404; // 404ä¹Ÿç®—å¯è®¿é—®
                } catch (error) {
                    console.log(`APIæ£€æµ‹å¤±è´¥ ${url}:`, error.message);
                    return false;
                }
            },

            async checkAllAPIs() {
                console.log('å¼€å§‹æ£€æµ‹APIè¿æ¥çŠ¶æ€...');

                const authCheck = this.checkAPI(CFG.authURL);
                const orbCheck = this.checkAPI(CFG.orbAPI + '/ping');

                const [authOk, orbOk] = await Promise.all([authCheck, orbCheck]);

                CFG.API_STATUS.auth = authOk ? 'ok' : 'blocked';
                CFG.API_STATUS.orb = orbOk ? 'ok' : 'blocked';

                const allOk = authOk && orbOk;

                console.log('APIæ£€æµ‹ç»“æœ:', {
                    auth: CFG.API_STATUS.auth,
                    orb: CFG.API_STATUS.orb,
                    allOk
                });

                // å¦‚æœAPIä¸å¯ç”¨ï¼Œè‡ªåŠ¨å¯ç”¨æµ‹è¯•æ¨¡å¼
                if (!allOk && !CFG.TEST_MODE) {
                    console.log('æ£€æµ‹åˆ°CORSé—®é¢˜ï¼Œè‡ªåŠ¨å¯ç”¨æµ‹è¯•æ¨¡å¼');
                    CFG.TEST_MODE = true;
                    localStorage.setItem('testMode', 'true');
                }

                this.updateStatusUI(allOk);
                return allOk;
            },

            updateStatusUI(apiOk) {
                const statusDiv = $('#cors-status');
                if (!statusDiv) return;

                if (apiOk) {
                    statusDiv.className = 'success';
                    statusDiv.innerHTML = `
                        <h3>âœ… APIè¿æ¥æ­£å¸¸</h3>
                        <p>æ‰€æœ‰å¤–éƒ¨APIéƒ½å¯ä»¥æ­£å¸¸è®¿é—®ï¼ŒåŠŸèƒ½å®Œå…¨å¯ç”¨ã€‚</p>
                    `;
                } else {
                    statusDiv.className = 'info';
                    statusDiv.innerHTML = `
                        <h3>âš ï¸ æ£€æµ‹åˆ°CORSè·¨åŸŸé—®é¢˜</h3>
                        <p>æ— æ³•ç›´æ¥è®¿é—®å¤–éƒ¨APIï¼Œå·²è‡ªåŠ¨å¯ç”¨<strong>æµ‹è¯•æ¨¡å¼</strong>ã€‚æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å¯ç”¨ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰ã€‚</p>
                        <div style="margin-top: 12px;">
                            <strong>è§£å†³æ–¹æ¡ˆï¼š</strong>
                            <div style="margin: 8px 0; font-size: 14px;">
                                <button class="btn btn-secondary" onclick="corsManager.tryProxy()" style="margin-right: 8px;">ğŸ”„ å°è¯•ä»£ç†</button>
                                <button class="btn btn-secondary" onclick="corsManager.showCORSSolutions()" style="margin-right: 8px;">ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ</button>
                                <button class="btn btn-secondary" onclick="corsManager.recheckAPIs()">ğŸ” é‡æ–°æ£€æµ‹</button>
                            </div>
                        </div>
                    `;
                }
            },

            async tryProxy() {
                showToast('æ­£åœ¨å°è¯•CORSä»£ç†...', 'info');

                for (const proxy of CFG.CORS_PROXIES) {
                    try {
                        const testUrl = proxy + encodeURIComponent(CFG.orbAPI + '/ping');
                        const response = await fetch(testUrl, {
                            method: 'GET',
                            timeout: 3000
                        });

                        if (response.ok) {
                            showToast(`ä»£ç† ${proxy} å¯ç”¨ï¼`, 'success');
                            // æ›´æ–°é…ç½®ä½¿ç”¨ä»£ç†
                            CFG.orbAPI = proxy + encodeURIComponent(CFG.orbAPI);
                            CFG.authURL = proxy + encodeURIComponent(CFG.authURL);
                            CFG.TEST_MODE = false;
                            localStorage.setItem('testMode', 'false');
                            this.updateStatusUI(true);
                            return;
                        }
                    } catch (error) {
                        console.log(`ä»£ç† ${proxy} ä¸å¯ç”¨:`, error);
                    }
                }

                showToast('æ‰€æœ‰ä»£ç†éƒ½ä¸å¯ç”¨ï¼Œç»§ç»­ä½¿ç”¨æµ‹è¯•æ¨¡å¼', 'info');
            },

            showCORSSolutions() {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999;
                    display: flex; align-items: center; justify-content: center;
                `;

                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: var(--bg); border-radius: 12px; padding: 20px;
                    max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;
                    box-shadow: 0 25px 60px -12px rgba(0,0,0,.28);
                `;

                dialog.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: var(--fg);">ğŸ› ï¸ CORSè§£å†³æ–¹æ¡ˆ</h2>
                        <button id="close-solutions" class="btn btn-ghost">âœ•</button>
                    </div>
                    <div style="color: var(--fg); line-height: 1.6;">
                        <h4>æ–¹æ¡ˆ1ï¼šæµè§ˆå™¨æ‰©å±•ï¼ˆæ¨èï¼‰</h4>
                        <ul>
                            <li>Chrome: å®‰è£… "CORS Unblock" æˆ– "Disable CORS" æ‰©å±•</li>
                            <li>Firefox: å®‰è£… "CORS Everywhere" æ‰©å±•</li>
                            <li>Edge: å®‰è£… "CORS Helper" æ‰©å±•</li>
                        </ul>

                        <h4>æ–¹æ¡ˆ2ï¼šChromeå¯åŠ¨å‚æ•°</h4>
                        <p>å…³é—­Chromeï¼Œç„¶åç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ï¼š</p>
                        <code style="background: var(--panel); padding: 8px; border-radius: 4px; display: block; margin: 8px 0;">
                            chrome.exe --disable-web-security --user-data-dir="C:/temp/chrome_dev"
                        </code>

                        <h4>æ–¹æ¡ˆ3ï¼šç»§ç»­ä½¿ç”¨æµ‹è¯•æ¨¡å¼</h4>
                        <p>å½“å‰å·²å¯ç”¨æµ‹è¯•æ¨¡å¼ï¼Œæ‰€æœ‰åŠŸèƒ½éƒ½å¯æ­£å¸¸ä½¿ç”¨ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæ¼”ç¤ºï¼‰ã€‚</p>

                        <div style="margin-top: 20px; padding: 12px; background: var(--panel); border-radius: 8px;">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong> è§£å†³CORSé—®é¢˜åï¼Œç‚¹å‡»"é‡æ–°æ£€æµ‹"æŒ‰é’®å³å¯åˆ‡æ¢åˆ°çœŸå®APIæ¨¡å¼ã€‚
                        </div>
                    </div>
                `;

                overlay.appendChild(dialog);
                document.body.appendChild(overlay);

                $('#close-solutions').onclick = () => overlay.remove();
                overlay.onclick = (e) => {
                    if (e.target === overlay) overlay.remove();
                };
            },

            async recheckAPIs() {
                showToast('é‡æ–°æ£€æµ‹APIè¿æ¥...', 'info');
                const statusDiv = $('#cors-status');
                if (statusDiv) {
                    statusDiv.innerHTML = '<h3>ğŸ”„ é‡æ–°æ£€æµ‹ä¸­...</h3><p>æ­£åœ¨æ£€æµ‹APIè¿æ¥çŠ¶æ€ï¼Œè¯·ç¨å€™...</p>';
                }

                const apiOk = await this.checkAllAPIs();
                if (apiOk) {
                    showToast('APIè¿æ¥æ¢å¤æ­£å¸¸ï¼', 'success');
                    CFG.TEST_MODE = false;
                    localStorage.setItem('testMode', 'false');
                    showCredentialManagement(); // åˆ·æ–°ç•Œé¢
                } else {
                    showToast('APIä»ç„¶ä¸å¯ç”¨ï¼Œç»§ç»­ä½¿ç”¨æµ‹è¯•æ¨¡å¼', 'info');
                }
            }
        };
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('é¡µé¢å¼€å§‹åˆå§‹åŒ–...');

            try {
                // åŠ è½½æµ‹è¯•æ¨¡å¼è®¾ç½®
                loadTestModeFromStorage();
                console.log('æµ‹è¯•æ¨¡å¼:', CFG.TEST_MODE);

                // æµ‹è¯•åŸºç¡€å‡½æ•°
                console.log('æµ‹è¯•$å‡½æ•°:', typeof $ === 'function');
                console.log('æµ‹è¯•storeå¯¹è±¡:', typeof store === 'object');
                console.log('æµ‹è¯•actionså¯¹è±¡:', typeof actions === 'object');

                // æ£€æµ‹APIè¿æ¥çŠ¶æ€
                await corsManager.checkAllAPIs();

                // åˆå§‹åŒ–æµ‹è¯•æ•°æ®ï¼ˆå¦‚æœæ²¡æœ‰æ•°æ®çš„è¯ï¼‰
                let creds = store.get();
                if (creds.length === 0) {
                    const testCreds = [
                        {
                            id: Date.now() + 1,
                            email: 'MartinDana3025@outlook.com',
                            tenant: 'https://d4.api.augmentcode.com/',
                            token: '7626fd13cec564c2f5222f5de7538bd651cc3fd1f26dcda17141580418c190fb',
                            subToken: 'IlN4bVRMRFVScG55emJETjMi.OirKwyZ8PNXu4_WkiN8_ZuryrWk',
                            lastBalance: '50.00',
                            lastIncluded: '50.00',
                            lastEndDate: '2025-08-31T12:19:44+00:00',
                            status: 'ACTIVE',
                            updatedAt: Date.now()
                        },
                        {
                            id: Date.now() + 2,
                            email: 'nanno502@outlook.com',
                            tenant: 'https://d1.api.augmentcode.com/',
                            token: '966f6fba318e1c873934bbbecbf7ab433725e8248322365ec39ab3896b7df91f',
                            subToken: 'IkZIdDdqSE1KYlg4UGdhOGIi.5VkUByDnl66K_uMfaIZvgZ_lNhc',
                            lastBalance: '50.00',
                            lastIncluded: '50.00',
                            lastEndDate: '2025-08-31T12:48:21+00:00',
                            status: 'ACTIVE',
                            updatedAt: Date.now()
                        },
                        {
                            id: Date.now() + 3,
                            email: 'a5@nanno.qzz.io',
                            tenant: 'https://d11.api.augmentcode.com/',
                            token: '1111b4e96be9c13110e8ac3384afa843c62fe7c74c691b0030b0090923e14e1d',
                            subToken: 'IldYUm9CZDVnY3A2RnZQZmEi.6ACnr-1e8Jlcr1yuDfESsyY1d4E',
                            lastBalance: '',
                            lastIncluded: '',
                            lastEndDate: '',
                            status: 'EXPIRED',
                            updatedAt: Date.now()
                        },
                        {
                            id: Date.now() + 4,
                            email: 'gzzd1qh7@isco.eu.org',
                            tenant: 'https://d8.api.augmentcode.com/',
                            token: '69d0b5394367931da3ad6fda2c0614eb8c363be0499b31ce1cb2116187129bdf',
                            subToken: 'IkJtaEE4UjNQVG5hUWYzdU4i.5A-Qe1Fcsd6EVeMSPaaFUk0ZrF0',
                            lastBalance: '0.00',
                            lastIncluded: '50.00',
                            lastEndDate: '2025-09-06T17:05:51+00:00',
                            status: 'NO_BALANCE',
                            updatedAt: Date.now()
                        }
                    ];
                    store.set(testCreds);
                    console.log('åˆå§‹åŒ–æµ‹è¯•æ•°æ®å®Œæˆ');
                } else {
                    console.log('å·²æœ‰æ•°æ®ï¼Œè·³è¿‡åˆå§‹åŒ–');
                }

                // ç»‘å®šäº‹ä»¶
                const navAuth = $('#nav-auth');
                const navImport = $('#nav-import');
                const navExport = $('#nav-export');

                console.log('æ‰¾åˆ°çš„å…ƒç´ :', {
                    navAuth: !!navAuth,
                    navImport: !!navImport,
                    navExport: !!navExport
                });

                if (navAuth) {
                    navAuth.onclick = actions.auth;
                    console.log('è·å–ä»¤ç‰ŒæŒ‰é’®ç»‘å®šå®Œæˆ');
                }
                if (navImport) {
                    navImport.onclick = actions.import;
                    console.log('å¯¼å…¥æ•°æ®æŒ‰é’®ç»‘å®šå®Œæˆ');
                }
                if (navExport) {
                    navExport.onclick = actions.export;
                    console.log('å¯¼å‡ºæ•°æ®æŒ‰é’®ç»‘å®šå®Œæˆ');
                }

                // éšè—åŠ è½½ï¼Œæ˜¾ç¤ºå°±ç»ªçŠ¶æ€ï¼Œå¹¶ç›´æ¥æ˜¾ç¤ºå‡­è¯ç®¡ç†ç•Œé¢
                setTimeout(() => {
                    try {
                        const loading = $('#loading');
                        const ready = $('#ready');
                        if (loading) loading.style.display = 'none';
                        if (ready) ready.style.display = 'block';
                        console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                        showToast('âœ… åº”ç”¨ç¨‹åºå·²å°±ç»ªï¼', 'success');

                        // ç›´æ¥æ˜¾ç¤ºå‡­è¯ç®¡ç†ç•Œé¢
                        showCredentialManagement();
                    } catch (timeoutError) {
                        console.error('å»¶è¿Ÿåˆå§‹åŒ–å¤±è´¥:', timeoutError);
                    }
                }, 1000);

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                const loading = $('#loading');
                if (loading) {
                    loading.innerHTML = `
                        <h3 style="color: #ef4444;">åˆå§‹åŒ–å¤±è´¥</h3>
                        <p>é”™è¯¯: ${error.message}</p>
                        <p>å †æ ˆ: ${error.stack}</p>
                        <button class="btn btn-primary" onclick="location.reload()">é‡æ–°åŠ è½½</button>
                    `;
                }
            }
        });
        
        console.log('è„šæœ¬åŠ è½½å®Œæˆ');
    </script>
</body>
</html>
