<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Augment 凭证管理工具</title>
    <style>
        :root{--bg:#fff;--fg:#0f172a;--muted:#64748b;--panel:#f8fafc;--bd:#e2e8f0;--chip:#eef2f7}
        @media (prefers-color-scheme: dark){
          :root{--bg:#0b1220;--fg:#e5eefc;--muted:#9fb0ca;--panel:#0e1729;--bd:#1d2a44;--chip:#0f1b33}
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--panel);
            color: var(--fg);
            min-height: 100vh;
        }

        .main-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg);
            border-radius: 18px;
            box-shadow: 0 4px 12px -4px rgba(0,0,0,.18);
        }

        .main-header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            color: var(--fg);
        }

        .main-header p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
        }

        .main-nav {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: var(--chip);
            color: var(--fg);
            border: 1px solid var(--bd);
        }

        .btn-secondary:hover {
            background: var(--bd);
        }

        .btn-ghost {
            background: transparent;
            color: var(--muted);
            border: 1px solid var(--bd);
        }

        .btn-ghost:hover {
            background: var(--chip);
            color: var(--fg);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .status-box {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px -2px rgba(0,0,0,.1);
        }

        .spin {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--bd);
            border-top: 2px solid var(--fg);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stat-item {
            color: var(--muted);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="main-header">
        <h1>🔑 Augment 凭证管理</h1>
        <p>管理您的 Augment 账户凭证和订阅信息</p>
    </div>
    
    <div class="main-nav">
        <button id="nav-auth" class="btn btn-primary">🚀 获取令牌</button>
        <button id="nav-import" class="btn btn-ghost">📥 导入数据</button>
        <button id="nav-export" class="btn btn-ghost">📤 导出数据</button>
        <button id="nav-proxy" class="btn btn-ghost">🌐 代理配置</button>
    </div>

    <div id="status" class="status-box">
        <div id="loading">
            <span class="spin"></span>
            正在初始化...
        </div>
        <div id="ready" style="display: none;">
            ✅ 系统就绪，可以开始使用各项功能
        </div>
    </div>

    <!-- CORS 连接状态展示 -->
    <div id="cors-status" class="status-box" style="display: none;"></div>

    <!-- 主要内容区域 -->
    <div id="main-content" style="margin-top: 20px;">
        <!-- 这里将显示凭证管理界面 -->
    </div>

    <!-- 引入CORS代理配置和网络状态管理 -->
    <script src="cors-proxy-config.js"></script>
    <script src="network-status.js"></script>

    <script>
        console.log('开始加载脚本...');

        // 注册 Service Worker（可选）
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('cors-proxy-sw.js')
                .then(registration => console.log('🔧 Service Worker 注册成功'))
                .catch(error => console.log('Service Worker 注册失败:', error));
        }
        
        // 基础工具函数
        const $ = s => document.querySelector(s);
        const json = s => { try { return JSON.parse(s); } catch { return null; } };
        const now = () => Date.now();
        
        // 简单的存储管理
        const store = {
            get: () => {
                try {
                    const data = localStorage.getItem('augment_creds') || '[]';
                    return JSON.parse(data);
                } catch {
                    return [];
                }
            },
            set: list => {
                try {
                    localStorage.setItem('augment_creds', JSON.stringify(list || []));
                    return true;
                } catch {
                    return false;
                }
            }
        };
        
        // 改进的UI提示系统
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? '#f0fdf4' : type === 'error' ? '#fef2f2' : type === 'warning' ? '#fef3c7' : '#f0f9ff';
            const textColor = type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : type === 'warning' ? '#92400e' : '#0369a1';
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';

            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: ${bgColor}; color: ${textColor}; border: 1px solid;
                border-radius: 12px; padding: 12px 16px; box-shadow: 0 4px 12px rgba(0,0,0,.15);
                max-width: 350px; word-wrap: break-word; font-size: 14px;
                display: flex; align-items: center; gap: 8px;
            `;
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            document.body.appendChild(toast);

            // 如果是错误消息，显示时间更长
            const actualDuration = type === 'error' ? Math.max(duration, 5000) : duration;
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, actualDuration);
        }

        // 显示详细错误信息的函数
        function showDetailedError(title, details, solutions = []) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: var(--bg); border-radius: 12px; padding: 20px;
                max-width: 500px; width: 90vw; box-shadow: 0 25px 60px -12px rgba(0,0,0,.28);
            `;

            const solutionsHtml = solutions.length > 0 ? `
                <div style="margin-top: 15px;">
                    <strong>建议解决方案：</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                        ${solutions.map(s => `<li style="margin: 4px 0;">${s}</li>`).join('')}
                    </ul>
                </div>
            ` : '';

            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #dc2626;">❌ ${title}</h3>
                    <button id="close-error" class="btn btn-ghost">✕</button>
                </div>
                <div style="color: var(--muted); margin-bottom: 15px; font-size: 14px;">
                    ${details}
                </div>
                ${solutionsHtml}
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                    <button id="retry-with-proxy" class="btn btn-primary">使用代理重试</button>
                    <button id="open-cors-solutions" class="btn btn-secondary">查看方案</button>
                    <button id="retry-connection" class="btn btn-secondary">重试连接</button>
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // 绑定事件
            dialog.querySelector('#close-error').onclick = () => overlay.remove();
            dialog.querySelector('#retry-with-proxy').onclick = async () => {
                overlay.remove();
                try { await corsManager.tryProxy(); } catch {}
            };
            dialog.querySelector('#open-cors-solutions').onclick = () => {
                overlay.remove();
                corsManager.showCORSSolutions();
            };
            dialog.querySelector('#retry-connection').onclick = () => {
                overlay.remove();
                if (typeof corsManager !== 'undefined') {
                    corsManager.recheckAPIs();
                }
            };

            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };
        }
        
        // 配置常量
        const CFG = {
            clientID: 'v',
            authURL: 'https://auth.augmentcode.com/authorize',
            orbAPI: 'https://portal.withorb.com/api/v1',
            pricingUnit: 'jWTJo9ptbapMWkvg',
            CONCURRENCY: 4,
            PAGE_SIZE: 18,
            // 智能代理管理器
            proxyManager: null,
            // API连接状态
            API_STATUS: {
                auth: 'unknown',
                orb: 'unknown'
            }
        };

        // 工具函数（从Augment.js移植）
        const rand = n => {
            const a = new Uint8Array(n);
            crypto.getRandomValues(a);
            return btoa(String.fromCharCode(...a)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
        };
        const sha256 = s => crypto.subtle.digest('SHA-256', new TextEncoder().encode(s));
        const b64url = buf => btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');

        // 智能fetch包装器：GET 优先代理；非GET 先直连后代理
        const safeFetch = async (url, options = {}) => {
            // 确保代理管理器已初始化
            if (!CFG.proxyManager && window.SmartCORSProxy) {
                try {
                    const ok = await window.SmartCORSProxy.init();
                    if (ok) CFG.proxyManager = window.SmartCORSProxy;
                } catch (e) {
                    console.log('初始化CORS代理失败:', e?.message);
                }
            }

            const method = (options.method || 'GET').toUpperCase();

            // GET: 优先代理
            if (method === 'GET' && CFG.proxyManager) {
                try {
                    const proxyResponse = await CFG.proxyManager.fetch(url, {
                        ...options,
                        headers: {
                            ...options.headers,
                            'Accept': 'application/json'
                        }
                    });
                    // 代理返回 401/403 可能源自代理限制（未激活/预检等），触发直连回退
                    if (proxyResponse.status === 401 || proxyResponse.status === 403) {
                        throw new Error('代理未授权或禁止，触发直连回退');
                    }
                    return proxyResponse;
                } catch (proxyError) {
                    console.log('代理请求失败，尝试直接请求:', proxyError.message);
                }
            }

            // 直连尝试（非GET优先；或GET的代理失败时回退）
            try {
                const response = await fetch(url, {
                    ...options,
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        ...options.headers,
                        'Accept': 'application/json'
                    }
                });
                if (response.status === 401) {
                    throw new Error('认证失败');
                }
                return response;
            } catch (directErr) {
                // 非GET：直连失败再尝试代理
                if (method !== 'GET' && CFG.proxyManager) {
                    try {
                        const proxyResponse = await CFG.proxyManager.fetch(url, {
                            ...options,
                            headers: {
                                ...options.headers,
                                'Accept': 'application/json'
                            }
                        });
                        if (proxyResponse.status === 401) {
                            throw new Error('认证失败');
                        }
                        return proxyResponse;
                    } catch (proxyErr) {
                        console.log('直连与代理均失败:', proxyErr.message);
                        throw proxyErr;
                    }
                }
                throw directErr;
            }
        };

        // OAuth 认证相关（完整实现）
        const oauth = {
            async start() {
                const email = await this.getEmailFromUser();
                if (!email || !email.includes('@')) return;

                try {
                    const verifier = rand(64);
                    const challenge = b64url(await sha256(verifier));
                    const state = rand(16);

                    // 保存认证状态
                    localStorage.setItem('oauth_state', JSON.stringify({ verifier, challenge, state, email }));

                    // 构建认证URL
                    const params = new URLSearchParams({
                        response_type: 'code',
                        client_id: CFG.clientID,
                        code_challenge: challenge,
                        code_challenge_method: 'S256',
                        state: state,
                        prompt: 'login'
                    });

                    const authURL = `${CFG.authURL}?${params}`;
                    showToast('正在打开认证页面...', 'info');
                    window.open(authURL, '_blank');

                } catch (error) {
                    console.error('OAuth启动失败:', error);
                    showToast('认证启动失败: ' + error.message, 'error');
                }
            },

            async getEmailFromUser() {
                return new Promise((resolve) => {
                    // 创建邮箱输入对话框
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999;
                        display: flex; align-items: center; justify-content: center;
                    `;

                    const dialog = document.createElement('div');
                    dialog.style.cssText = `
                        background: var(--bg); border-radius: 12px; padding: 20px;
                        max-width: 400px; width: 90vw; box-shadow: 0 25px 60px -12px rgba(0,0,0,.28);
                    `;

                    dialog.innerHTML = `
                        <h3 style="margin: 0 0 16px 0; color: var(--fg);">🚀 获取令牌</h3>
                        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 16px;">
                            <input id="email-name" style="
                                flex: 1; padding: 8px 10px; border: 1px solid var(--bd);
                                border-radius: 8px; background: var(--bg); color: var(--fg);
                            " placeholder="邮箱本地名 或 完整邮箱"/>
                            <select id="email-domain" style="
                                padding: 8px 10px; border: 1px solid var(--bd);
                                border-radius: 8px; background: var(--bg); color: var(--fg);
                            ">
                                <option value="@outlook.com">@outlook.com</option>
                                <option value="@gmail.com">@gmail.com</option>
                                <option value="@hotmail.com">@hotmail.com</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button id="cancel-btn" class="btn btn-secondary">取消</button>
                            <button id="ok-btn" class="btn btn-primary">确定</button>
                        </div>
                    `;

                    overlay.appendChild(dialog);
                    document.body.appendChild(overlay);

                    const nameInput = dialog.querySelector('#email-name');
                    const domainSelect = dialog.querySelector('#email-domain');
                    const cancelBtn = dialog.querySelector('#cancel-btn');
                    const okBtn = dialog.querySelector('#ok-btn');

                    const close = () => {
                        try { overlay.remove(); } catch {}
                    };

                    const submit = () => {
                        const name = (nameInput.value || '').trim();
                        if (!name) return;

                        const email = name.includes('@') ? name : name + (domainSelect.value || '@outlook.com');
                        close();
                        resolve(email);
                    };

                    okBtn.onclick = submit;
                    cancelBtn.onclick = () => { close(); resolve(''); };

                    dialog.addEventListener('keydown', e => {
                        if (e.key === 'Enter') submit();
                        if (e.key === 'Escape') { close(); resolve(''); }
                    });

                    nameInput.focus();
                });
            },

            async token(tenant, code) {
                const oauthState = JSON.parse(localStorage.getItem('oauth_state') || '{}');
                const { verifier } = oauthState;
                if (!verifier) throw new Error('认证状态丢失');

                const url = tenant.endsWith('/') ? `${tenant}token` : `${tenant}/token`;
                const response = await safeFetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grant_type: 'authorization_code',
                        client_id: CFG.clientID,
                        code_verifier: verifier,
                        redirect_uri: '',
                        code
                    })
                });

                const result = await response.json();
                return result.access_token || (() => { throw new Error('获取令牌失败'); })();
            }
        };

        // 余额检查功能（完整实现，带CORS处理）
        const balance = {
            async getBanStatus(tenant, token) {
                if (!tenant || !token) return 'ERROR';
                const url = tenant.endsWith('/') ? `${tenant}api/v1/me` : `${tenant}/api/v1/me`;
                try {
                    const response = await safeFetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json'
                        }
                    });
                    if (response.ok) return 'OK';
                    if (response.status === 404) return 'OK';
                    if (response.status === 403) return 'BANNED';
                    if (response.status === 402) return 'EXPIRED';
                    if (response.status === 401) return 'EXPIRED';
                    return 'ERROR';
                } catch (error) {
                    console.error('检查封禁状态失败:', error);
                    return 'ERROR';
                }
            },

            async info(token) {
                try {
                    // 获取订阅信息
                    const subResponse = await safeFetch(`${CFG.orbAPI}/subscriptions_from_link?token=${token}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!subResponse.ok) {
                        if (subResponse.status === 401) {
                            throw new Error('Token无效或已过期');
                        }
                        throw new Error(`订阅API请求失败: ${subResponse.status}`);
                    }

                    const sub = await subResponse.json();
                    const item = sub.data?.[0];
                    const customer = item?.customer;
                    if (!customer) throw new Error('订阅信息错误');

                    // 获取余额信息
                    const balResponse = await safeFetch(`${CFG.orbAPI}/customers/${customer.id}/ledger_summary?pricing_unit_id=${CFG.pricingUnit}&token=${token}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!balResponse.ok) {
                        if (balResponse.status === 401) {
                            throw new Error('Token无效或已过期');
                        }
                        throw new Error(`余额API请求失败: ${balResponse.status}`);
                    }

                    const bal = await balResponse.json();

                    // 获取包含额度
                    let included;
                    try {
                        const pi = (item.price_intervals || []).find(x =>
                            x.allocation && x.allocation.pricing_unit?.id === CFG.pricingUnit
                        );
                        included = pi?.allocation?.amount;
                    } catch {}

                    return {
                        email: customer.email,
                        balance: bal.credits_balance,
                        endDate: item.end_date,
                        included
                    };
                } catch (error) {
                    console.error('获取订阅信息失败:', error);
                    throw error;
                }
            },
            

            async check(cred) {
                console.log(`开始检测凭证: ${cred.email || cred.id}`);

                try {
                    // 检查基本信息
                    if (!cred.token && !cred.subToken) {
                        console.log('凭证缺少token和subToken');
                        const updatedCred = {
                            ...cred,
                            status: 'NO_TOKEN',
                            updatedAt: Date.now()
                        };
                        this.updateCredential(updatedCred);
                        return 'NO_TOKEN';
                    }

                    // 检查封禁状态
                    if (cred.token && cred.tenant) {
                        console.log('检查封禁状态...');
                        const banStatus = await this.getBanStatus(cred.tenant, cred.token);
                        console.log(`封禁状态检查结果: ${banStatus}`);

                        if (banStatus === 'BANNED' || banStatus === 'EXPIRED') {
                            const updatedCred = {
                                ...cred,
                                status: banStatus,
                                lastBalance: null,
                                lastIncluded: null,
                                updatedAt: Date.now()
                            };
                            this.updateCredential(updatedCred);
                            return banStatus;
                        }
                    }

                    // 检查subToken
                    if (!cred.subToken) {
                        console.log('缺少subToken');
                        const updatedCred = {
                            ...cred,
                            status: 'NO_TOKEN',
                            updatedAt: Date.now()
                        };
                        this.updateCredential(updatedCred);
                        return 'NO_TOKEN';
                    }

                    // 获取详细信息
                    console.log('获取订阅信息...');
                    const info = await this.info(cred.subToken);
                    console.log('订阅信息:', info);

                    const expired = info.endDate && Date.now() > new Date(info.endDate);
                    const status = expired ? 'EXPIRED' : (info.balance <= 0 ? 'NO_BALANCE' : 'ACTIVE');

                    console.log(`最终状态: ${status}`);

                    const updatedCred = {
                        ...cred,
                        status,
                        lastBalance: info.balance,
                        lastEndDate: info.endDate,
                        lastIncluded: info.included,
                        updatedAt: Date.now()
                    };
                    this.updateCredential(updatedCred);
                    return status;

                } catch (error) {
                    console.error('检测凭证失败:', error);

                    // 根据错误类型提供更详细的状态和用户提示
                    let errorStatus = 'ERROR';
                    let errorMessage = error.message;
                    if (error.message.includes('Token无效')) {
                        errorStatus = 'NO_TOKEN';
                        errorMessage = 'Token无效或已过期';
                    } else if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                        errorStatus = 'NETWORK_ERROR';
                        errorMessage = '网络连接问题';

                        // 显示详细错误信息
                        showDetailedError(
                            '网络连接失败',
                            `无法连接到服务器检测凭证状态。这可能是由于网络问题或CORS限制导致的。`,
                            [
                                '使用代理重试',
                                '打开 CORS 解决方案',
                                '检查网络连接',
                                '尝试使用浏览器扩展解决CORS问题',
                                '稍后重试'
                            ]
                        );
                    } else if (error.message.includes('认证失败')) {
                        errorStatus = 'AUTH_ERROR';
                        errorMessage = '认证失败';
                    }

                    const updatedCred = {
                        ...cred,
                        status: errorStatus,
                        lastError: errorMessage,
                        updatedAt: Date.now()
                    };
                    this.updateCredential(updatedCred);
                    return errorStatus;
                }
            },

            updateCredential(updatedCred) {
                const creds = store.get();
                const index = creds.findIndex(c => c.id == updatedCred.id);
                if (index !== -1) {
                    creds[index] = updatedCred;
                    store.set(creds);
                }
            }
        };

        // 凭证管理界面
        function showManageDialog() {
            const creds = store.get();

            // 创建模态框
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: var(--bg); border-radius: 12px; padding: 20px;
                max-width: 800px; width: 90vw; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 25px 60px -12px rgba(0,0,0,.28);
            `;

            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--fg);">🔑 凭证管理</h2>
                    <button id="close-dialog" class="btn btn-ghost">✕</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <button id="add-cred" class="btn btn-primary">➕ 添加凭证</button>
                    <button id="clear-all" class="btn btn-danger" style="margin-left: 10px;">🗑️ 清空所有</button>
                </div>
                <div id="creds-list">
                    ${creds.length === 0 ?
                        '<div style="text-align: center; color: var(--muted); padding: 40px;">暂无凭证数据</div>' :
                        creds.map((cred, index) => `
                            <div style="border: 1px solid var(--bd); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${cred.email || '未知邮箱'}</strong>
                                        <div style="font-size: 12px; color: var(--muted);">
                                            ID: ${cred.id || 'N/A'} | 状态: ${cred.status || '未知'}
                                        </div>
                                    </div>
                                    <button class="btn btn-danger btn-sm" onclick="deleteCred(${index})">删除</button>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // 绑定事件
            $('#close-dialog').onclick = () => overlay.remove();
            $('#add-cred').onclick = () => {
                const email = prompt('请输入邮箱:');
                const tenant = prompt('请输入租户URL:');
                if (email && tenant) {
                    const newCred = {
                        id: Date.now(),
                        email: email,
                        tenant: tenant,
                        status: 'NEW',
                        updatedAt: Date.now()
                    };
                    const creds = store.get();
                    creds.push(newCred);
                    store.set(creds);
                    showToast('凭证已添加', 'success');
                    overlay.remove();
                    showManageDialog(); // 重新打开
                }
            };
            $('#clear-all').onclick = () => {
                if (confirm('确定要清空所有凭证吗？')) {
                    store.set([]);
                    showToast('所有凭证已清空', 'success');
                    overlay.remove();
                }
            };

            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };
        }

        // 删除凭证
        window.deleteCred = function(index) {
            const creds = store.get();
            if (confirm(`确定要删除凭证 "${creds[index]?.email}" 吗？`)) {
                creds.splice(index, 1);
                store.set(creds);
                showToast('凭证已删除', 'success');
                document.querySelector('.modal-overlay')?.remove();
                showManageDialog();
            }
        };

        // 先声明actions对象，稍后赋值
        const actions = {};

        // 导入对话框
        function showImportDialog() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: var(--bg); border-radius: 12px; padding: 20px;
                max-width: 800px; width: 90vw; max-height: 80vh;
                box-shadow: 0 25px 60px -12px rgba(0,0,0,.28);
            `;

            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--fg);">📥 导入数据</h2>
                    <button id="close-import" class="btn btn-ghost">✕</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <p style="color: var(--muted); margin: 0 0 10px 0;">支持格式：JSON数组、JSONL（每行一个JSON对象）、CSV</p>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <select id="dedup-mode" class="btn btn-ghost" style="padding: 6px 10px;">
                            <option value="fullEmail">去重：完整邮箱</option>
                            <option value="nameKey">去重：邮箱本地名</option>
                            <option value="subToken">去重：subToken</option>
                        </select>
                        <select id="merge-mode" class="btn btn-ghost" style="padding: 6px 10px;">
                            <option value="overwrite">合并：覆盖全部字段</option>
                            <option value="onlyEmpty">合并：仅空字段</option>
                            <option value="newer">合并：时间较新</option>
                        </select>
                    </div>
                </div>
                <textarea id="import-text" placeholder="请粘贴要导入的数据..." style="
                    width: 100%; height: 300px; padding: 10px; border: 1px solid var(--bd);
                    border-radius: 8px; background: var(--panel); color: var(--fg);
                    font-family: ui-monospace, monospace; font-size: 12px; resize: vertical;
                "></textarea>
                <div id="import-error" style="color: #dc2626; font-size: 12px; margin-top: 5px; display: none;"></div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                    <button id="preview-import" class="btn btn-secondary">预览合并</button>
                    <button id="do-import" class="btn btn-primary">直接导入</button>
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // 绑定事件
            $('#close-import').onclick = () => overlay.remove();
            $('#do-import').onclick = () => doImport(false);
            $('#preview-import').onclick = () => doImport(true);

            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };

            function doImport(preview = false) {
                const text = $('#import-text').value.trim();
                const errorDiv = $('#import-error');

                if (!text) {
                    errorDiv.textContent = '请输入要导入的数据';
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    let data = [];

                    // 尝试解析不同格式
                    if (text.startsWith('[')) {
                        // JSON数组格式
                        data = JSON.parse(text);
                    } else if (text.includes('\n') && text.split('\n').every(line => !line.trim() || line.trim().startsWith('{'))) {
                        // JSONL格式
                        data = text.split('\n').filter(line => line.trim()).map(line => JSON.parse(line));
                    } else {
                        // CSV格式
                        data = parseCSV(text);
                    }

                    if (!Array.isArray(data)) {
                        throw new Error('数据格式错误，需要数组格式');
                    }

                    if (preview) {
                        showImportPreview(data);
                    } else {
                        // 直接导入
                        const currentCreds = store.get();
                        const mergedData = [...currentCreds, ...data];
                        store.set(mergedData);
                        showToast(`成功导入 ${data.length} 个凭证`, 'success');
                        overlay.remove();
                    }

                } catch (error) {
                    errorDiv.textContent = '解析失败: ' + error.message;
                    errorDiv.style.display = 'block';
                }
            }
        }

        // 导出对话框
        function showExportDialog() {
            const creds = store.get();
            const dataStr = JSON.stringify(creds, null, 2);

            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: var(--bg); border-radius: 12px; padding: 20px;
                max-width: 800px; width: 90vw; max-height: 80vh;
                box-shadow: 0 25px 60px -12px rgba(0,0,0,.28);
            `;

            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--fg);">📤 导出数据</h2>
                    <button id="close-export" class="btn btn-ghost">✕</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <p style="color: var(--muted); margin: 0 0 10px 0;">共 ${creds.length} 个凭证 - 可编辑后保存更改</p>
                    <div style="display: flex; gap: 10px;">
                        <button id="copy-data" class="btn btn-secondary">📋 复制到剪贴板</button>
                        <button id="save-changes" class="btn btn-primary">💾 保存更改</button>
                    </div>
                </div>
                <textarea id="export-text" style="
                    width: 100%; height: 400px; padding: 10px; border: 1px solid var(--bd);
                    border-radius: 8px; background: var(--panel); color: var(--fg);
                    font-family: ui-monospace, monospace; font-size: 12px; resize: vertical;
                ">${dataStr}</textarea>
                <div id="export-status" style="font-size: 12px; margin-top: 5px; display: none;"></div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // 绑定事件
            $('#close-export').onclick = () => overlay.remove();
            $('#copy-data').onclick = () => {
                const textarea = $('#export-text');
                textarea.select();
                navigator.clipboard?.writeText(textarea.value);
                showToast('已复制到剪贴板', 'success');

                const btn = $('#copy-data');
                const originalText = btn.textContent;
                btn.textContent = '✅ 已复制';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1000);
            };

            $('#save-changes').onclick = () => {
                try {
                    const newData = JSON.parse($('#export-text').value);
                    if (Array.isArray(newData)) {
                        store.set(newData);
                        showToast('更改已保存', 'success');
                        overlay.remove();
                    } else {
                        throw new Error('数据格式错误');
                    }
                } catch (error) {
                    const statusDiv = $('#export-status');
                    statusDiv.textContent = '保存失败: ' + error.message;
                    statusDiv.style.color = '#dc2626';
                    statusDiv.style.display = 'block';
                }
            };

            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };

            // 自动选中文本
            setTimeout(() => {
                $('#export-text').focus();
            }, 100);
        }

        // CSV解析函数
        function parseCSV(text) {
            const lines = text.replace(/\r/g, '').split('\n').filter(Boolean);
            if (!lines.length) return [];

            const headers = splitCSVLine(lines[0]);
            return lines.slice(1).map(line => {
                const values = splitCSVLine(line);
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header.trim()] = values[index] || '';
                });
                return obj;
            });
        }

        function splitCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(s => s.trim());
        }

        // 导入预览功能
        function showImportPreview(data) {
            showToast(`预览功能开发中，将直接导入 ${data.length} 个凭证`, 'info');
            const currentCreds = store.get();
            const mergedData = [...currentCreds, ...data];
            store.set(mergedData);
            showToast(`成功导入 ${data.length} 个凭证`, 'success');
            document.querySelector('[style*="position: fixed"]')?.remove();
        }

        // —— 代理配置管理弹窗 ——
        function showProxyManagerDialog() {
            const cloneDeep = (x) => JSON.parse(JSON.stringify(x));
            const initialList = (window.SmartCORSProxy?.getEffectiveProxies?.() || window.CORSProxyConfig?.proxies || []).map(p => ({
                name: p.name || '',
                url: p.url || p.base || '',
                reliable: !!p.reliable,
                rateLimit: p.rateLimit || '',
                supportsMethods: Array.isArray(p.supportsMethods) ? p.supportsMethods.slice() : ['GET'],
                supportsHeaders: p.supportsHeaders !== false
            }));
            let list = cloneDeep(initialList);

            const overlay = document.createElement('div');
            overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999; display: flex; align-items: center; justify-content: center;`;

            const dialog = document.createElement('div');
            dialog.style.cssText = `background: var(--bg); color: var(--fg); border-radius: 14px; padding: 18px; width: 80vw; height: 80vh; overflow: auto; box-shadow: 0 25px 60px -12px rgba(0,0,0,.35);`;

            const rowStyle = `display:grid;grid-template-columns:28px 1fr 2fr 120px 160px 140px 120px;gap:8px;align-items:center;padding:8px;border:1px solid var(--bd);border-radius:8px;background:var(--panel);`;

            function render() {
                dialog.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <h2 style="margin:0;">🌐 代理配置</h2>
                        <button id="proxy-close" class="btn btn-ghost">✕</button>
                    </div>
                    <div style="color:var(--muted);font-size:13px;margin-bottom:10px;">
                        配置公共/自建 CORS 代理，调整顺序即为尝试顺序。可运行自检以评估“连通性/转发头/POST”能力。
                    </div>
                    <div style="background: var(--panel); border: 1px solid var(--bd); border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 12px; line-height: 1.6;">
                        <strong>说明：</strong>
                        <ul style="margin: 8px 0 0 18px; padding: 0;">
                            <li><strong>可靠性</strong>：这是你对该代理的主观“可信度/稳定性”标记，用于排序与优先尝试；不代表实时可用性。</li>
                            <li><strong>方法(GET/POST)</strong>：声明该代理理论上支持的请求方法。未勾选 POST 时，该代理不会被用于 POST 请求的候选。</li>
                            <li><strong>转发自定义头</strong>：声明该代理理论上可转发如 Authorization 等自定义请求头。实际效果可能因浏览器预检而受限，请结合“🧪 自检”结果判定。</li>
                        </ul>
                        <div style="color: var(--muted); margin-top: 6px;">
                            注：AllOrigins/ThingProxy 通常不转发自定义头；CORS Anywhere 可能需要先激活；自建/Vercel 函数代理一般可转发头且支持 POST。
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:28px 1fr 2fr 120px 160px 140px 120px;gap:8px;margin:6px 0 8px 0;color:var(--muted);font-size:12px;">
                        <div>#</div>
                        <div>名称</div>
                        <div>基址</div>
                        <div>可靠性</div>
                        <div>方法(GET/POST)</div>
                        <div>转发自定义头</div>
                        <div>排序</div>
                    </div>
                    <div id="proxy-list" style="display:flex;flex-direction:column;gap:8px;"></div>
                    <div style="display:flex;gap:8px;margin:10px 0 6px 0;">
                        <button id="proxy-add" class="btn btn-secondary">➕ 添加代理</button>
                        <button id="proxy-reset" class="btn btn-ghost">↩️ 重置为默认</button>
                        <div style="margin-left:auto;display:flex;gap:8px;">
                            <button id="proxy-save" class="btn btn-primary">💾 保存并重新检测</button>
                            <button id="proxy-probe" class="btn btn-secondary">🧪 运行自检</button>
                            <button id="proxy-toggle-json" class="btn btn-ghost">🧾 显示JSON</button>
                            <button id="proxy-copy" class="btn btn-ghost">📋 复制结果</button>
                        </div>
                    </div>
                    <div id="proxy-summary" style="display:none;margin:8px 0 6px 0;"></div>
                    <div id="proxy-report" style="display:none;border:1px solid var(--bd);border-radius:10px;overflow:hidden;"></div>
                    <pre id="proxy-result" style="display:none;background:#0b1220;color:#e5eefc;border-radius:10px;padding:12px;max-height:220px;overflow:auto;font-size:12px;">(无)</pre>
                `;

                const listEl = dialog.querySelector('#proxy-list');

                listEl.innerHTML = '';
                list.forEach((p, idx) => {
                    const row = document.createElement('div');
                    row.style.cssText = rowStyle;
                    row.innerHTML = `
                        <div style="text-align:center;color:var(--muted);">${idx + 1}</div>
                        <input data-k="name" value="${p.name || ''}" placeholder="名称" style="padding:8px;border:1px solid var(--bd);border-radius:8px;background:var(--bg);color:var(--fg);"/>
                        <input data-k="url" value="${p.url || ''}" placeholder="https://example.com/?url=" style="padding:8px;border:1px solid var(--bd);border-radius:8px;background:var(--bg);color:var(--fg);"/>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--fg);"><input data-k="reliable" type="checkbox" ${p.reliable ? 'checked' : ''}/> 可靠</label>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--fg);"><input data-k="mGET" type="checkbox" ${p.supportsMethods?.includes('GET') ? 'checked' : ''}/> GET <input data-k="mPOST" type="checkbox" style="margin-left:10px;" ${p.supportsMethods?.includes('POST') ? 'checked' : ''}/> POST</label>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--fg);"><input data-k="supportsHeaders" type="checkbox" ${p.supportsHeaders ? 'checked' : ''}/> 可转发头</label>
                        <div style="display:flex;gap:6px;justify-content:flex-end;">
                            <button class="btn btn-ghost btn-sm" data-action="up" title="上移">⬆️</button>
                            <button class="btn btn-ghost btn-sm" data-action="down" title="下移">⬇️</button>
                            <button class="btn btn-danger btn-sm" data-action="del" title="删除">🗑️</button>
                        </div>
                    `;

                    // input bindings
                    row.querySelectorAll('input').forEach(inp => {
                        inp.onchange = (e) => {
                            const k = inp.dataset.k;
                            if (k === 'name') list[idx].name = inp.value;
                            if (k === 'url') list[idx].url = inp.value;
                            if (k === 'reliable') list[idx].reliable = inp.checked;
                            if (k === 'supportsHeaders') list[idx].supportsHeaders = inp.checked;
                            if (k === 'mGET' || k === 'mPOST') {
                                const hasGet = row.querySelector('[data-k="mGET"]').checked;
                                const hasPost = row.querySelector('[data-k="mPOST"]').checked;
                                const methods = [];
                                if (hasGet) methods.push('GET');
                                if (hasPost) methods.push('POST');
                                list[idx].supportsMethods = methods.length ? methods : ['GET'];
                            }
                        };
                    });

                    // actions
                    row.querySelectorAll('button').forEach(btn => {
                        btn.onclick = () => {
                            const act = btn.dataset.action;
                            if (act === 'up' && idx > 0) {
                                [list[idx - 1], list[idx]] = [list[idx], list[idx - 1]];
                                render();
                            } else if (act === 'down' && idx < list.length - 1) {
                                [list[idx + 1], list[idx]] = [list[idx], list[idx + 1]];
                                render();
                            } else if (act === 'del') {
                                list.splice(idx, 1);
                                render();
                            }
                        };
                    });

                    listEl.appendChild(row);
                });

                // toolbar buttons
                dialog.querySelector('#proxy-close').onclick = () => overlay.remove();
                dialog.querySelector('#proxy-add').onclick = () => { list.push({ name: '', url: '', reliable: false, rateLimit: '', supportsMethods: ['GET'], supportsHeaders: true }); render(); };
                dialog.querySelector('#proxy-reset').onclick = async () => {
                    try {
                        window.SmartCORSProxy?.resetProxies?.();
                        list = cloneDeep(window.SmartCORSProxy?.getEffectiveProxies?.() || window.CORSProxyConfig?.proxies || []);
                        render();
                        showToast('已重置为默认代理列表', 'success');
                    } catch (e) {
                        showToast('重置失败: ' + (e?.message || e), 'error');
                    }
                };
                dialog.querySelector('#proxy-save').onclick = async () => {
                    try {
                        const sanitized = list.filter(p => (p.url || '').trim());
                        window.SmartCORSProxy?.setUserProxies?.(sanitized);
                        const ok = await window.SmartCORSProxy?.init?.();
                        const st = window.SmartCORSProxy?.getStatus?.() || {};
                        showToast(`代理列表已保存并检测：可用 ${st.workingCount || 0} 个，当前 ${st.currentProxy || 'None'}`, ok ? 'success' : 'warning');
                    } catch (e) {
                        showToast('保存失败: ' + (e?.message || e), 'error');
                    }
                };
                dialog.querySelector('#proxy-probe').onclick = async () => {
                    const btn = dialog.querySelector('#proxy-probe');
                    const pre = dialog.querySelector('#proxy-result');
                    btn.disabled = true; btn.textContent = '🧪 自检中...'; pre.textContent = '(运行中...)';
                    try {
                        const report = await window.SmartCORSProxy?.probeProxies?.({ proxies: list, timeoutMs: 8000 }) || [];
                        pre.textContent = JSON.stringify(report, null, 2);
                        // 可视化渲染
                        const sumEl = dialog.querySelector('#proxy-summary');
                        const repEl = dialog.querySelector('#proxy-report');
                        const esc = (s) => String(s || '').replaceAll('<','&lt;').replaceAll('>','&gt;');
                        const total = report.length;
                        const reach = report.filter(r => r.simpleGet?.ok).length;
                        const headers = report.filter(r => r.forwardedAuthorization).length;
                        const posts = report.filter(r => r.postSupported).length;
                        sumEl.innerHTML = `
                            <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
                                <span>总计: <strong>${total}</strong></span>
                                <span>可达: <strong style="color:#16a34a">${reach}</strong></span>
                                <span>转发头: <strong style="color:${headers>0?'#16a34a':'#64748b'}">${headers}</strong></span>
                                <span>POST: <strong style="color:${posts>0?'#16a34a':'#dc2626'}">${posts}</strong></span>
                            </div>`;
                        const header = `
                            <div style="display:grid;grid-template-columns:1.6fr 0.9fr 0.9fr 0.8fr 0.6fr 0.5fr 2fr;gap:0;border-bottom:1px solid var(--bd);background:var(--bg);color:var(--muted);font-size:12px;">
                                <div style="padding:8px 10px;">代理</div>
                                <div style="padding:8px 10px;">连通性</div>
                                <div style="padding:8px 10px;">转发头</div>
                                <div style="padding:8px 10px;">POST</div>
                                <div style="padding:8px 10px;">延迟</div>
                                <div style="padding:8px 10px;">HTTP</div>
                                <div style="padding:8px 10px;">备注</div>
                            </div>`;
                        const yes = (t) => `<span style="background:#dcfce7;color:#166534;border:1px solid #bbf7d0;padding:2px 6px;border-radius:999px;font-size:12px;">✅ ${t}</span>`;
                        const no = (t) => `<span style="background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:2px 6px;border-radius:999px;font-size:12px;">❌ ${t}</span>`;
                        const neutral = (t) => `<span style="background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;padding:2px 6px;border-radius:999px;font-size:12px;">— ${t}</span>`;
                        const rows = report.map(r => {
                            const reachOk = !!(r.simpleGet && r.simpleGet.ok);
                            const status = (r.simpleGet && typeof r.simpleGet.status !== 'undefined') ? r.simpleGet.status : '-';
                            const latency = (r.simpleGet && r.simpleGet.latencyMs) ? `${r.simpleGet.latencyMs}ms` : '-';
                            const fwd = !!r.forwardedAuthorization;
                            const post = !!r.postSupported;
                            return `
                                <div style="display:grid;grid-template-columns:1.6fr 0.9fr 0.9fr 0.8fr 0.6fr 0.5fr 2fr;gap:0;border-top:1px solid var(--bd);">
                                    <div style="padding:10px;">
                                        <div style="font-weight:600;">${esc(r.name)}</div>
                                        <div style="color:var(--muted);font-size:12px;margin-top:2px;">${esc(r.base || '')}</div>
                                    </div>
                                    <div style="padding:10px;">${reachOk ? yes('可达') : no('失败')}</div>
                                    <div style="padding:10px;">${fwd ? yes('已转发') : neutral('不保证')}</div>
                                    <div style="padding:10px;">${post ? yes('支持') : no('不支持')}</div>
                                    <div style="padding:10px;">${latency}</div>
                                    <div style="padding:10px;">${status}</div>
                                    <div style="padding:10px;color:var(--muted);font-size:12px;">${esc(r.notes || '')}</div>
                                </div>`;
                        }).join('');
                        repEl.innerHTML = header + rows;
                        sumEl.style.display = 'block';
                        repEl.style.display = 'block';
                        showToast('自检完成', 'success');
                    } catch (e) {
                        pre.textContent = '自检失败: ' + (e?.message || e);
                        showToast('自检失败', 'error');
                    } finally {
                        btn.disabled = false; btn.textContent = '🧪 运行自检';
                    }
                };
                // Toggle raw JSON visibility
                dialog.querySelector('#proxy-toggle-json').onclick = () => {
                    const pre = dialog.querySelector('#proxy-result');
                    const btn = dialog.querySelector('#proxy-toggle-json');
                    const showing = pre.style.display !== 'none';
                    pre.style.display = showing ? 'none' : 'block';
                    btn.textContent = showing ? '🧾 显示JSON' : '🧾 隐藏JSON';
                };
                dialog.querySelector('#proxy-copy').onclick = async () => {
                    const pre = dialog.querySelector('#proxy-result');
                    const text = pre?.textContent || '';
                    try { await navigator.clipboard?.writeText(text); showToast('结果已复制', 'success'); } catch {}
                };
            }

            render();
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
        }

        // 现在给actions对象赋值
        actions.auth = function() {
            try {
                oauth.start();
            } catch (error) {
                console.error('OAuth启动失败:', error);
                showToast('认证启动失败: ' + error.message, 'error');
            }
        };

        actions.manage = function() {
            try {
                showCredentialManagement(); // 刷新凭证管理界面
                showToast('凭证列表已刷新', 'success');
            } catch (error) {
                console.error('管理功能启动失败:', error);
                showToast('管理功能启动失败: ' + error.message, 'error');
            }
        };

        actions.import = function() {
            try {
                showImportDialog();
            } catch (error) {
                console.error('导入对话框打开失败:', error);
                showToast('导入功能启动失败: ' + error.message, 'error');
            }
        };

        actions.export = function() {
            try {
                showExportDialog();
            } catch (error) {
                console.error('导出对话框打开失败:', error);
                showToast('导出功能启动失败: ' + error.message, 'error');
            }
        };

        // 显示凭证管理界面（在主页面上，不是弹窗）
        function showCredentialManagement() {
            const creds = store.get();
            const mainContent = $('#main-content');

            if (!mainContent) return;

            if (creds.length === 0) {
                // 没有凭证时显示空状态
                mainContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
                        <h3>🔑 暂无凭证</h3>
                        <p>点击上方"获取令牌"按钮开始添加凭证</p>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="actions.auth()">🚀 获取令牌</button>
                            <button class="btn btn-ghost" onclick="actions.import()" style="margin-left: 10px;">📥 导入数据</button>
                        </div>
                    </div>
                `;
                return;
            }

            // 有凭证时显示卡片网格
            let cardsHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; padding: 20px 0;">';

            creds.forEach(cred => {
                const statusColor = getStatusColor(cred.status || 'UNKNOWN');
                const statusText = getStatusText(cred.status || 'UNKNOWN');

                cardsHtml += `
                    <div class="credential-card" data-cred-id="${cred.id}" style="
                        background: var(--bg);
                        border: 2px solid ${statusColor.border};
                        border-radius: 12px;
                        padding: 16px;
                        box-shadow: 0 4px 12px -4px rgba(0,0,0,.1);
                        position: relative;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <h4 style="margin: 0; color: var(--fg); font-size: 16px; font-weight: 600;">
                                ${cred.email || `ID: ${cred.id}`}
                            </h4>
                            <span style="
                                background: ${statusColor.bg};
                                color: ${statusColor.text};
                                padding: 4px 8px;
                                border-radius: 6px;
                                font-size: 12px;
                                font-weight: 600;
                            ">${statusText}</span>
                        </div>

                        <div style="margin-bottom: 12px; font-size: 14px; color: var(--muted);">
                            <div style="margin-bottom: 4px;">🌐 ${cred.tenant || '未设置'}</div>
                            ${cred.lastBalance ? `<div style="margin-bottom: 4px;">💰 余额: ${cred.lastBalance}</div>` : ''}
                            ${cred.lastIncluded ? `<div style="margin-bottom: 4px;">📦 总额度: ${cred.lastIncluded}</div>` : ''}
                            ${cred.lastEndDate ? `<div style="margin-bottom: 4px;">📅 到期: ${new Date(cred.lastEndDate).toLocaleDateString()}</div>` : ''}
                        </div>

                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button class="btn btn-secondary check-btn" style="font-size: 12px; padding: 6px 12px;" onclick="checkCredential('${cred.id}')">检测</button>
                            <button class="btn btn-danger" style="font-size: 12px; padding: 6px 12px;" onclick="deleteCredential('${cred.id}')">删除</button>
                        </div>
                    </div>
                `;
            });

            cardsHtml += '</div>';

            // 添加统计信息和操作按钮
            const stats = getCredentialStats(creds);
            const testModeIndicator = '';

            const statsHtml = `
                <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                    <div class="stat-item">总计: <span style="font-weight: 600;">${stats.total}</span></div>
                    <div class="stat-item">正常: <span style="color: #16a34a; font-weight: 600;">${stats.active}</span></div>
                    <div class="stat-item">异常: <span style="color: #dc2626; font-weight: 600;">${stats.abnormal}</span></div>
                    <div class="stat-item">无令牌: <span style="color: #64748b; font-weight: 600;">${stats.noToken}</span></div>
                    ${testModeIndicator}
                    <div style="margin-left: auto;">
                        <button class="btn btn-primary" onclick="checkAllCredentials()" style="margin-right: 10px;">🔄 全部检测</button>
                        <button class="btn btn-secondary" onclick="corsManager.recheckAPIs()" style="margin-right: 10px;">🔍 检测连接</button>
                        <button class="btn btn-secondary" onclick="window.NetworkStatusManager?.showDiagnostics()" style="margin-right: 10px;">🩺 网络诊断</button>
                        <button class="btn btn-secondary" onclick="actions.import()">📥 导入</button>
                        <button class="btn btn-secondary" onclick="actions.export()">📤 导出</button>
                    </div>
                </div>
            `;

            mainContent.innerHTML = statsHtml + cardsHtml;
        }

        // 获取状态颜色
        function getStatusColor(status) {
            const colors = {
                'ACTIVE': { bg: '#dcfce7', text: '#166534', border: '#16a34a' },
                'EXPIRED': { bg: '#fee2e2', text: '#991b1b', border: '#dc2626' },
                'NO_BALANCE': { bg: '#fef3c7', text: '#92400e', border: '#f59e0b' },
                'ERROR': { bg: '#fef2f2', text: '#991b1b', border: '#ef4444' },
                'NO_TOKEN': { bg: '#f1f5f9', text: '#475569', border: '#64748b' },
                'NETWORK_ERROR': { bg: '#fef3c7', text: '#92400e', border: '#f59e0b' },
                'AUTH_ERROR': { bg: '#fee2e2', text: '#991b1b', border: '#dc2626' },
                'BANNED': { bg: '#fef2f2', text: '#991b1b', border: '#ef4444' },
                'UNKNOWN': { bg: '#f8fafc', text: '#64748b', border: '#cbd5e1' }
            };
            return colors[status] || colors['UNKNOWN'];
        }

        // 获取状态文本
        function getStatusText(status) {
            const texts = {
                'ACTIVE': '正常',
                'EXPIRED': '已过期',
                'NO_BALANCE': '余额不足',
                'ERROR': '检测失败',
                'NO_TOKEN': '无令牌',
                'NETWORK_ERROR': '网络错误',
                'AUTH_ERROR': '认证失败',
                'BANNED': '账户被封',
                'UNKNOWN': '未知'
            };
            return texts[status] || '未知';
        }

        // 获取凭证统计信息
        function getCredentialStats(creds) {
            return {
                total: creds.length,
                active: creds.filter(c => c.status === 'ACTIVE').length,
                abnormal: creds.filter(c => ['EXPIRED', 'NO_BALANCE', 'ERROR', 'NETWORK_ERROR', 'AUTH_ERROR', 'BANNED'].includes(c.status)).length,
                noToken: creds.filter(c => c.status === 'NO_TOKEN').length,
                networkError: creds.filter(c => c.status === 'NETWORK_ERROR').length
            };
        }

        // 检测凭证
        async function checkCredential(id) {
            const creds = store.get();
            const cred = creds.find(c => c.id == id);
            if (!cred) {
                showToast('凭证不存在', 'error');
                return;
            }

            // 显示检测中状态
            showCredentialLoading(id, true);
            showToast('正在检测凭证...', 'info');

            try {
                const status = await balance.check(cred);
                const statusText = getStatusText(status);
                showToast(`检测完成: ${statusText}`, 'success');

                // 刷新显示
                showCredentialManagement();
            } catch (error) {
                console.error('检测失败:', error);
                showToast('检测失败: ' + error.message, 'error');
            } finally {
                showCredentialLoading(id, false);
            }
        }

        // 显示检测中状态
        function showCredentialLoading(id, isLoading) {
            const card = document.querySelector(`[data-cred-id="${id}"]`);
            if (!card) return;

            const checkBtn = card.querySelector('.check-btn');
            if (checkBtn) {
                if (isLoading) {
                    checkBtn.disabled = true;
                    checkBtn.innerHTML = '<span class="spin" style="width: 12px; height: 12px; margin-right: 4px;"></span>检测中...';
                } else {
                    checkBtn.disabled = false;
                    checkBtn.innerHTML = '检测';
                }
            }
        }

        // 删除凭证
        function deleteCredential(id) {
            if (confirm('确定要删除这个凭证吗？')) {
                const creds = store.get();
                const newCreds = creds.filter(c => c.id != id);
                store.set(newCreds);
                showToast('凭证已删除', 'success');
                showCredentialManagement(); // 刷新显示
            }
        }

        // 全部检测功能
        async function checkAllCredentials() {
            const creds = store.get();
            if (creds.length === 0) {
                showToast('没有凭证需要检测', 'info');
                return;
            }

            showToast(`开始检测 ${creds.length} 个凭证...`, 'info');

            // 显示所有卡片的检测状态
            creds.forEach(cred => showCredentialLoading(cred.id, true));

            let completed = 0;
            const results = { success: 0, error: 0 };

            // 并发检测，限制并发数
            const concurrency = CFG.CONCURRENCY || 4;
            const tasks = creds.map(cred => async () => {
                try {
                    const status = await balance.check(cred);
                    results.success++;
                    console.log(`凭证 ${cred.email} 检测完成: ${status}`);
                } catch (error) {
                    results.error++;
                    console.error(`凭证 ${cred.email} 检测失败:`, error);
                } finally {
                    completed++;
                    showCredentialLoading(cred.id, false);

                    // 更新进度
                    if (completed % 2 === 0 || completed === creds.length) {
                        showToast(`检测进度: ${completed}/${creds.length}`, 'info');
                    }
                }
            });

            // 执行并发任务
            await runConcurrentTasks(tasks, concurrency);

            // 显示最终结果
            showToast(`检测完成！成功: ${results.success}, 失败: ${results.error}`, 'success');

            // 刷新显示
            showCredentialManagement();
        }

        // 并发任务执行器
        async function runConcurrentTasks(tasks, limit) {
            return new Promise(resolve => {
                let index = 0;
                let running = 0;
                let completed = 0;

                const next = () => {
                    while (running < limit && index < tasks.length) {
                        const taskIndex = index++;
                        running++;
                        tasks[taskIndex]().finally(() => {
                            running--;
                            completed++;
                            next();
                        });
                    }
                    if (completed === tasks.length) {
                        resolve();
                    }
                };
                next();
            });
        }

        // CORS检测和状态管理
        const corsManager = {
            async checkAPI(url, timeout = 5000) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);

                    const response = await fetch(url, {
                        method: 'HEAD',
                        mode: 'cors',
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    return response.ok || response.status === 404; // 404也算可访问
                } catch (error) {
                    console.log(`API检测失败 ${url}:`, error.message);
                    return false;
                }
            },

            async checkAllAPIs() {
                console.log('开始检测API连接状态...');

                const authCheck = this.checkAPI(CFG.authURL);
                const orbCheck = this.checkAPI(CFG.orbAPI + '/ping');

                const [authOk, orbOk] = await Promise.all([authCheck, orbCheck]);

                CFG.API_STATUS.auth = authOk ? 'ok' : 'blocked';
                CFG.API_STATUS.orb = orbOk ? 'ok' : 'blocked';

                const allOk = authOk && orbOk;

                console.log('API检测结果:', {
                    auth: CFG.API_STATUS.auth,
                    orb: CFG.API_STATUS.orb,
                    allOk
                });

                // 如果API不可用，提示使用代理
                if (!allOk) {
                    console.log('检测到CORS问题，建议使用公共CORS代理');
                }

                this.updateStatusUI(allOk);
                return allOk;
            },

            updateStatusUI(apiOk) {
                const statusDiv = $('#cors-status');
                if (!statusDiv) return;

                if (apiOk) {
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'status-box success';
                    statusDiv.innerHTML = `
                        <h3>✅ API连接正常</h3>
                        <p>所有外部API都可以正常访问，功能完全可用。</p>
                    `;
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'status-box info';
                    statusDiv.innerHTML = `
                        <h3>⚠️ 检测到CORS跨域问题</h3>
                        <p>无法直接访问外部API。您可以点击“尝试代理”使用公共CORS代理，或查看“解决方案”。</p>
                        <div style="margin-top: 12px;">
                            <strong>操作：</strong>
                            <div style="margin: 8px 0; font-size: 14px;">
                                <button class="btn btn-secondary" onclick="corsManager.tryProxy()" style="margin-right: 8px;">🔄 尝试代理</button>
                                <button class="btn btn-secondary" onclick="corsManager.showCORSSolutions()" style="margin-right: 8px;">🛠️ 解决方案</button>
                                <button class="btn btn-secondary" onclick="corsManager.recheckAPIs()">🔍 重新检测</button>
                            </div>
                        </div>
                    `;
                }
            },

            async tryProxy() {
                showToast('正在检测CORS代理...', 'info');

                try {
                    // 初始化智能代理管理器
                    if (window.SmartCORSProxy) {
                        const success = await window.SmartCORSProxy.init();

                        if (success) {
                            CFG.proxyManager = window.SmartCORSProxy;
                            const status = CFG.proxyManager.getStatus();

                            showToast(`✅ 找到可用代理: ${status.currentProxy}`, 'success');

                            // 测试代理是否真的可用
                            try {
                                await CFG.proxyManager.fetch('https://httpbin.org/json');
                                this.updateStatusUI(true);
                                return;
                            } catch (testError) {
                                console.log('代理测试失败:', testError);
                            }
                        }
                    }

                    showToast('❌ 没有找到可用的代理，请稍后重试或查看CORS解决方案', 'info');
                } catch (error) {
                    console.error('代理初始化失败:', error);
                    showToast('代理初始化失败', 'error');
                }
            },

            showCORSSolutions() {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999;
                    display: flex; align-items: center; justify-content: center;
                `;

                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: var(--bg); border-radius: 12px; padding: 20px;
                    max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;
                    box-shadow: 0 25px 60px -12px rgba(0,0,0,.28);
                `;

                dialog.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: var(--fg);">🛠️ CORS解决方案</h2>
                        <button id="close-solutions" class="btn btn-ghost">✕</button>
                    </div>
                    <div style="color: var(--fg); line-height: 1.6;">
                        <h4>方案1：使用公共CORS代理</h4>
                        <p>系统已内置并优先使用以下公共CORS代理：</p>
                        <ul>
                            <li><a href="https://api.allorigins.win/" target="_blank">AllOrigins</a> — https://api.allorigins.win/raw?url=</li>
                            <li><a href="https://corsproxy.io/" target="_blank">corsproxy.io</a> — https://corsproxy.io/?</li>
                            <li><a href="https://thingproxy.freeboard.io/" target="_blank">ThingProxy</a> — https://thingproxy.freeboard.io/fetch/</li>
                            <li><a href="https://vercel.com/" target="_blank">Proxy CORS (Vercel)</a> — https://proxy-cors.vercel.app/api/proxy?url=</li>
                        </ul>

                        <h4>方案2：浏览器扩展</h4>
                        <p>您也可以使用浏览器扩展来解决跨域问题。以下是一些可用的扩展：</p>
                        <ul>
                            <li>Chrome: 安装 "CORS Unblock" 或 "Disable CORS" 扩展</li>
                            <li>Firefox: 安装 "CORS Everywhere" 扩展</li>
                            <li>Edge: 安装 "CORS Helper" 扩展</li>
                        </ul>

                        <h4>方案3：修改浏览器配置</h4>
                        <p>您也可以修改浏览器配置来解决跨域问题。以下是一些可用的配置：</p>
                        <ul>
                            <li>Chrome: 启动 Chrome 时添加参数 "--disable-web-security --user-data-dir"</li>
                        </ul>
                    </div>
                `;

                overlay.appendChild(dialog);
                document.body.appendChild(overlay);

                $('#close-solutions').onclick = () => overlay.remove();
                overlay.onclick = (e) => {
                    if (e.target === overlay) overlay.remove();
                };
            },

            async recheckAPIs() {
                showToast('重新检测API连接...', 'info');
                const statusDiv = $('#cors-status');
                if (statusDiv) {
                    statusDiv.innerHTML = '<h3>🔄 重新检测中...</h3><p>正在检测API连接状态，请稍候...</p>';
                }

                const apiOk = await this.checkAllAPIs();
                if (apiOk) {
                    showToast('API连接恢复正常！', 'success');
                    showCredentialManagement(); // 刷新界面
                } else {
                    showToast('API仍然不可用，建议尝试代理或查看解决方案', 'info');
                }
            }
        };

        // 页面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('页面开始初始化...');

            try {
                // 测试基础函数
                console.log('测试$函数:', typeof $ === 'function');
                console.log('测试store对象:', typeof store === 'object');
                console.log('测试actions对象:', typeof actions === 'object');

                // 检测API连接状态
                await corsManager.checkAllAPIs();

                // 不注入测试数据

                // 绑定事件
                const navAuth = $('#nav-auth');
                const navImport = $('#nav-import');
                const navExport = $('#nav-export');

                console.log('找到的元素:', {
                    navAuth: !!navAuth,
                    navImport: !!navImport,
                    navExport: !!navExport
                });

                if (navAuth) {
                    navAuth.onclick = actions.auth;
                    console.log('获取令牌按钮绑定完成');
                }
                if (navImport) {
                    navImport.onclick = actions.import;
                    console.log('导入数据按钮绑定完成');
                }
                if (navExport) {
                    navExport.onclick = actions.export;
                    console.log('导出数据按钮绑定完成');
                }
                const navProxy = $('#nav-proxy');
                if (navProxy) {
                    navProxy.onclick = showProxyManagerDialog;
                    console.log('代理配置按钮绑定完成');
                }

                // 隐藏加载，显示就绪状态，并直接显示凭证管理界面
                setTimeout(() => {
                    try {
                        const loading = $('#loading');
                        const ready = $('#ready');
                        if (loading) loading.style.display = 'none';
                        if (ready) ready.style.display = 'block';
                        console.log('页面初始化完成');
                        showToast('✅ 应用程序已就绪！', 'success');

                        // 直接显示凭证管理界面
                        showCredentialManagement();
                    } catch (timeoutError) {
                        console.error('延迟初始化失败:', timeoutError);
                    }
                }, 1000);

            } catch (error) {
                console.error('初始化失败:', error);
                const loading = $('#loading');
                if (loading) {
                    loading.innerHTML = `
                        <h3 style="color: #ef4444;">初始化失败</h3>
                        <p>错误: ${error.message}</p>
                        <p>堆栈: ${error.stack}</p>
                        <button class="btn btn-primary" onclick="location.reload()">重新加载</button>
                    `;
                }
            }
        });
        
        console.log('脚本加载完成');
    </script>
</body>
</html>
